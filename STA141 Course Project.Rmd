---
title: "STA141A Course Project - Decoding Success: Understanding Mice Trials through Predictive Modeling"
author: "Hayat Botan"
date: "2024-02-07"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, eval=TRUE,   message=FALSE, include = FALSE}

suppressWarnings(library(tidyverse))
suppressWarnings(library(knitr))
suppressWarnings(library(readr))
suppressWarnings(library(dplyr))
suppressWarnings(library(ggplot2))
suppressWarnings(library(ggcorrplot))
suppressWarnings(library(gridExtra))
suppressWarnings(library(lubridate))
suppressWarnings(library(reshape2))
suppressWarnings(library(caret))
suppressWarnings(library(pROC))
suppressWarnings(library(xgboost))

```

```{r, echo=FALSE, eval=TRUE,   message=FALSE, include = FALSE}
# Load libraries
library(tidyverse)
library(knitr)
library(readr)        
library(dplyr)        
library(ggplot2)      
library(ggcorrplot)   
library(gridExtra)    
library(lubridate)    
library(reshape2)
library(caret)
library(pROC)
library(xgboost)

```


*Abstract*
The brain is a complex organ with over 80 billion neurons and cells. These neurons and cells provide the backbone for behavioral engagement that can be visualized through various neuroimaging techniques, electrophysiological recordings, and behavioral assays, offering insights into the intricate processes underlying cognitive functions and actions. However, with the increasing use of software, these neuroimaging techniques have been approached from a different angle in an effort to establish predictive inferential conclusions among several variables. This project seeks to analyze a subset of data from various experiments and clinical trials conducted by Steinmetz et al. In essence, the research by Steinmetz et al. involved experiments where mice were tasked with visual discriminatory stimuli to understand the distribution of neurons upon visual encoding and their subsequent actions. The decisions following the visual encoding have become of interest to Steinetz et al. and this project predicts engagement between neural activity and outcome (success/failure). Prior to building a predictive model, exploratory data analysis is undertaken to understand intricacies of the clinical data and establish features relevant to predicting outcome. We subsequently proceed to integrate our data to demonstrate crucial features of our data that would contribute the most to the success of a trial. The data analysis portion of this project has unveiled several noteworthy insights: 1) a predominant number of sessions contain trials that culminate in failures at the end of each session; 2) An observable correlation exists across the majority of brain areas in all sessions, indicating an increase in average spike counts (neural activity) is associated with success, while a decrease in average spike counts is linked to failure; 3) Failures in trials are more associated with a more concentrated distribution of average spike counts, albeit with some deviations & conversely, successes tend to result in a broader distribution of average spike counts, with reduced instances of outliers.

*Introduction*
This course project embarks on a journey to decipher the complexities of the brain, an organ teeming with over 80 billion neurons and cells, which form the cornerstone of our behavioral engagement. This engagement can be meticulously observed through a variety of neuroimaging methods, but ultimately, our endeavor is to meticulously analyze a subset of data derived from a series of experiments and clinical trials by Steinmetz et al. Their pioneering work involved subjecting mice to tasks that required discrimination based on visual stimuli, aiming to elucidate the role of neuronal distribution in visual encoding and the subsequent actions taken by these organisms. The focus of Steinmetz et al. on the decision-making processes post-visual encoding, particularly the association between neural activity and the outcomes of these decisions (success or failure), forms the foundation of our investigative project. This project, at its core, aims to predict the engagement between neural activity and outcomes (success or failure) in trials. By integrating our findings and focusing on the key features that emerged from our analysis, we set the stage for developing a predictive model that can potentially offer novel insights into the neural underpinnings of decision-making and behavior.

We will begin this project by doing EDA on each and individual session, on all mice, then on all sessions. We will conclude the EDA with a summary of my findings (which can be previewed in the Abstract & Introduction).

### Exploratory Data Analysis

```{r echo=TRUE, eval=TRUE}
# Set working directory
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

# Session 1 Base Evaluation (Mouse: Cori)
```{r, echo = FALSE}
session1 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session1.rds")
names(session1)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 114 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the experiment date. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[1]]$mouse_name

summary(session[[1]]$brain_area)
table(session[[1]]$brain_area)

summary(session[[1]]$contrast_left)
table(session[[1]]$contrast_left)
length(session[[1]]$contrast_left)

summary(session[[1]]$contrast_right)
table(session[[1]]$contrast_right)
length(session[[1]]$contrast_right)

summary(session[[1]]$feedback_type)
table(session[[1]]$feedback_type)
length(session[[1]]$feedback_type)

```
With the above code, we can see that this session evaluates mouse Cori's behavior and subsequent neural activity. There are 734 neurons found in 8 brain areas: ACA (109 neurons), CA3 (68 neurons), DG (34 neurons), LS (139 neurons), MOs (113 neurons), root (18 neurons), SUB (75 neurons), VISp (178 neurons). There are 114 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 45 trials resulted in a failure and 69 trials resulted in a success out of a total of 114 trials. Another way to look at that success-failure outcome is as follows: 39.47% of the the trials resulted in a failure; 60.53% of the trials resulted in a success. With these explorations, we must also explore Cori's performance over the 114 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 114 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Cori chose a specific contrast level on the left side: 0 was chosen 51 times, 0.25 was chosen 27 times, 0.5 was chosen 18 times, and 1 was chosen 18 times as well.  One interesting discovery here is that the median of choosing a contrast left value was 0.375, which is on the lower end. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is quite high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Cori was more inclined to choosing a lower contrast right value (without taking the contrast left values into consideration) in this one session. Here are the frequency statistics that indicate how often Cori chose a specific contrast level on the right side: 0 was chosen 43 times, 0.25 was chosen 14 times, 0.5 was chosen 23 times, and 1 was chosen 34 times. 

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 


# Data Analysis
```{r, echo = FALSE, include = FALSE}
n.session=1

meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)

for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;   
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area)); 
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
}

head(meta)
```

```{r, echo = FALSE}
# Visualize the feedback/outcome over the 114 trials in session 1

ss1_trial_data <- data.frame(
  trial_id = 1:114,  
  trial_outcome = c(1 , 1 ,-1, -1 ,-1 , 1 , 1 , 1  ,1,  1,  1 , 1, -1, -1, -1, -1,  1,  1,  1,  1,  1, -1, -1,  1,  1,  1,  1, -1,  1,  1,  1, -1,  1 , 1,  1,  1,  1,  1,  1,  1,  1, -1,  1,  1,  1,  1, -1,  1 ,-1,  1,  1,  1, -1, -1,  1,  1, -1, -1, -1,  1,  1,  1 ,-1, -1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1,  1,  1, -1,  1,  1,  1,  1, -1,  1 ,-1 , 1 ,-1, -1, -1, -1,  1, -1,  1 ,-1,  1 , 1 , 1, -1, -1, -1, -1,  1, -1,  1,  1, -1, -1, -1, -1, -1, -1, -1)
)

ggplot(ss1_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() + 
  geom_point() + 
  labs(x = "Trial", y = "Success = 1 or Failure = 0", title = "Success Rate per each Trial", ) +
  theme_minimal() 

```
This plot shows us the trend of successes and failures over the trials in session 1. We can see that are a couple of times where both successes and failures take place successively. For example, there are nearly 10 successive successes after the 30th and 60th trials; and nearly 10 successive failures towards the end of the session. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.

```{r, echo = FALSE, include = FALSE}

i.s=1 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, include = FALSE, echo = FALSE} 
# Wrapping up the function:

i.s = 1

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(1,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim=c(0,n.trial),ylim=c(0.5,4.5), xlab="Trials",ylab="Average spike counts", main=paste("Spikes per area in Session", i.s))


for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
Overall, with each trial in session 1, the average spike counts exhibit a gradual downward trend. Despite this generalization, it can be seen that for the CA3 region, the average spike counts tend to fluctuate greatly, then increase, and then plateau at about 1.3 spike counts. CA1 represents the first region of the hippocampal circuit which is known for its memory retrieval and spatial navigation abilities. With that, though mouse Cori decreases its average spike counts in other brain regions overtime, it can be said that the CA3 region continues to play an instrumental in role in allowing for Cori to make informed decision following a subsequent trial. With this, we can also go back to our first plot of this session and make some connections. Since, there were nearly 10 successive successes after the 30th and 60th trials, it can be seen that both the DG and SUB brain areas experience major spikes (in terms of its average spike counts). As for the 10 successive failures at the end of session 1, there is various smaller positive and negative spikes that are taking place in nearly all brain regions. 

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=1 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(1,this_session = session[[i.s]]) #note this only applies to session 1, trial 1




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

i.s = 2

trial.summary <- trial.summary %>%
  rename(
    ACA_avg_spk = ACA, 
    CA3_avg_spk = CA3, 
    DG_avg_spk = DG, 
    LS_avg_spk = LS, 
    MOs_avg_spk = MOs, 
    root_avg_spk = root, 
    SUB_avg_spk = SUB, 
    VISp_avg_spk = VISp
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)
print(trial.long)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
    geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and affirms what we have concluded above. One interesting feature of these plots here is that the CA3 and VISp brain areas experience less dramatic average spike changes; whereas the ACA and LS brain areas experience major average spike changes with numerous negative downward trends. What we have already found and will later find out is that Cori makes many successive failures towards the end of this session. This can lead to a preliminary finding that a decreasing average spike count could predict or even correlate with a failure in the decision making process (and vise versa). We will explore this next.

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the VISp brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions.

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=1 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(1,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 1

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 1

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 1 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the DG, SUB, and VISp brain areas generally have higher average spikes and this is seen throughout trials 1-114; whereas the MOs brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the MOs brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. 

--- 

```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

# Loop through each trial
for (i.t in 1:114) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)


```

```{r, echo= FALSE}
# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = ACA, y = feedback, colour = "red")) +
  xlab("ACA") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA3, y = feedback, colour = "red")) +
  xlab("CA3") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = DG, y = feedback, colour = "red")) +
  xlab("DG") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = LS, y = feedback, colour = "red")) +
  xlab("LS") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = MOs, y = feedback, colour = "red")) +
  xlab("MOs") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area")

p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = SUB, y = feedback, colour = "red")) +
  xlab("SUB") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISp, y = feedback, colour = "red")) +
  xlab("VISp") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, nrow = 4)

```
There are 8 plots that provide an understanding of what is taking place in each of the 8 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Cori makes a decision as to what contrast to choose. In all of these panels, Cori seems to either have a decreasing or stagnant average spike count at the end in each brain area.


```{r, echo = FALSE, include = FALSE}

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE, include = FALSE}
i.s = 1

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA3", "DG", "LS", "MOs", "root", "SUB", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 8 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the CA3, DG, and VISpm brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable average spike count, whereas the wrong decision leads to the occasional high or low average spike count. 

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA3", "DG", "LS", "MOs", "root", "SUB", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are far more outliers and skewness of average spike counts in the brain areas with negative feedback than positive feedback.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_1 <- get_session_data(1)
head(session_1)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_1)) {
  session_1$stimuli_condition <- factor(paste(session_1$contrast_left, session_1$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_1, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Cori was faced with 1-1, there was not a single success in between approximately 35 trials, and interestingly, this demonstrated a decrease in mean spike counts. This could be due to the random factor involved in what a success would be considered as by the scientists. Additionally, this failure in decision making is also seen in the 0.25-0.5 case, despite mean spike counts that seem rather normal in comparison to the rest of the mean spike counts. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes tend to result in higher neural activity on average despite great fluctuations, while failures tend to result in decreasing neural activity within panels. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_1 <- get_session_data(1)
head(session_1)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_1 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 114 trials but also has greater variation in its average spike counts. It is interesting to see that Cori ends this session with a lot of failures. 

# Session 2 Base Evaluation (Mouse: Cori)
```{r, echo = FALSE}
session2 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session2.rds")
names(session2)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 251 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[2]]$mouse_name

summary(session[[2]]$brain_area)
table(session[[2]]$brain_area)

summary(session[[2]]$contrast_left)
table(session[[2]]$contrast_left)
length(session[[2]]$contrast_left)

summary(session[[2]]$contrast_right)
table(session[[2]]$contrast_right)
length(session[[2]]$contrast_right)

summary(session[[2]]$feedback_type)
table(session[[2]]$feedback_type)
length(session[[2]]$feedback_type)

```
With the above code, we can see that this session also evaluates mouse Cori's behavior and subsequent neural activity. There are 1070 neurons found in 5 brain areas: CA1 (190 neurons), POST (191 neurons), root (156 neurons), VISl (231 neurons), VISpm (302 neurons). There are 251 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 92 trials resulted in a failure and 159 trials resulted in a success out of a total of 251 trials. Another way to look at that success-failure outcome is as follows: 36.65% of the the trials resulted in a failure; 63.35% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Cori, we can say that Cori's performance and ability to make decisions based on the visual stimuli is improving! With these explorations, we must also explore Cori's performance over the 114 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 251 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Cori chose a specific contrast level on the left side: 0 was chosen 133 times, 0.25 was chosen 25 times, 0.5 was chosen 39 times, and 1 was chosen 54 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the lower end. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is very high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Cori was more inclined to choosing a lower contrast right value (without taking the contrast left values into consideration) but higher in comparison to contrast left values. Here are the frequency statistics that indicate how often Cori chose a specific contrast level on the right side: 0 was chosen 115 times, 0.25 was chosen 41 times, 0.5 was chosen 34 times, and 1 was chosen 61 times. 

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 



# Data Analysis

```{r, echo = FALSE, include = FALSE}
n.session=2

i = 2  

tmp = session[[i]]  

# Initialize 'meta' with information from the second session
meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming you have a session data object, for example, for session_id 1
session_data <- get_session_data(2)  # Replace 1 with the actual session_id you're interested in

# Plotting the feedback over the trials
ggplot(session_data, aes(x = trail_id, y = feedback_type)) +
  geom_point() +  # This will plot a point for each trial's feedback
  geom_line(group = 1) +  # Connect points with lines to show the progression over time
  scale_y_continuous(breaks = c(-1, 1), labels = c("Failure", "Success")) +  # Label y-axis ticks for clarity
  labs(x = "Trial ID", y = "Feedback", title = sprintf("Feedback Over Trials for Session %d", 1)) +  # Update title with correct session_id
  theme_minimal()  # Use a minimal theme for a clean look


```

We can see that the trend of successes and failures over the trials in session 2. From our base evaluation from sessions 1 and 2, we know that Cori's success rate increases and thus this plot looks a lot different from the one in session 1. There are a lot less successive successes and failures in comparison to session 1 but this session also shows that Cori makes the wrong decision successively in the last 10 trials or so. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results. This will be visualized more at the end.


```{r, echo = FALSE, include = FALSE}

i.s=2 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 2

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(2,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 2.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim=c(0,n.trial),ylim=c(0.5,4.5), xlab="Trials",ylab="Average spike counts", main=paste("Spikes per area in Session", i.s))


for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that the average spike counts in each brain area are not that high, neither have great variation over the trials. The average spike counts in the VISpm brain area is relatively stable with small spikes in between trials. The CA1 and root brain regions experience the most fluctuations in its relative lines. Due to the lack of clear direction of the average spike counts over the trials, it will be difficult to understand the relationship between feedback and neural activity. This can be due to the increase in success rate in this session, as session 1 had a lower success rate and exhibited a decreasing average spike count across most brain areas.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=2 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 2

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(2,this_session = session[[i.s]]) #note this only applies to session 1, trial 1




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

# Session 4 Base Evaluation (Mouse: Forssmann)
```{r, echo = FALSE}
session4 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session4.rds")
names(session4)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 249 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[4]]$mouse_name

summary(session[[4]]$brain_area)
table(session[[4]]$brain_area)

summary(session[[4]]$contrast_left)
table(session[[4]]$contrast_left)
length(session[[4]]$contrast_left)

summary(session[[4]]$contrast_right)
table(session[[4]]$contrast_right)
length(session[[4]]$contrast_right)

summary(session[[4]]$feedback_type)
table(session[[4]]$feedback_type)
length(session[[4]]$feedback_type)

```
This is the first session that evaluates mouse Forssmann's behavior and subsequent neural activity. There are 1769 neurons found in 11 brain areas: ACA (304 neurons), CA1 (98 neurons), DG (144 neurons), LGd (140 neurons), LSr (435 neurons), MOs (92 neurons), SUB (108 neurons), TH (256 neurons), VISa (81 neurons), VISp (39 neurons), VPL (72 neurons). There are 249 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 83 trials resulted in a failure and 166 trials resulted in a success out of a total of 249 trials. Another way to look at that success-failure outcome is as follows: 33.33% of the the trials resulted in a failure; 66.67% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Cori in the previous session, we can say that Forssmann's first performances in session 4 is close to Cori's performance in session 3. From this, Forssmann is already achieving a higher level of success without much experience from previous sessions. This is when we must possibly think of Forssmann's previous experiences as a mouse; has Forssmann faced any experiments with similar visual stimuli before, or could Forssmann just be an older mouse with more life experiences that involve important decision making under duress. With these explorations, we must also explore Forssmann's performance over the 249 trials and find any gradual improvements over time within just this session. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 249 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the left side: 0 was chosen 112 times, 0.25 was chosen 41 times, 0.5 was chosen 46 times, and 1 was chosen 50 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is quite high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Forssmann was more inclined to choosing a lower contrast right value. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the right side: 0 was chosen 107 times, 0.25 was chosen 55 times, 0.5 was chosen 41 times, and 1 was chosen 46 times. 

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 



# Data Analysis


```{r, echo = FALSE}
n.session=4

i = 4

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss4_trial_data <- data.frame(
  trial_id = 1:249
)

trial_outcome_vector <- as.vector(session[[4]]$feedback_type[, 1])

ss4_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss4_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 4. From our base evaluation from sessions 1-3 (Mouse: Cori), we know that Forssmann's success rate in this session is higher than in any of Cori's sessions. There are a lot less successive successes in the middle of this session.The successive successes are a lot more frequent in this session compared to the successive failures. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=4 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 4

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(4,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 4.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in sessions 1-2. It is also important to note that some of these brain areas with the lower average spike count haven't been evaluated before, such as the TH, LP, and SPF regions.  

The average spike counts in the root brain area is relatively stable with small dips in spikes in between trials. This is interesting because all brain areas experience a common dip in average spikes at about the 200th trial mark. The VPL and TH brain regions experience the most fluctuations in its relative lines. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate (as Forssmann had a higher success rate than in any of Cori's sessions.)

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=4 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 4

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(4,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    ACA_avg_spk = ACA, 
    CA1_avg_spk = CA1, 
    DG_avg_spk = DG, 
    LGd_avg_spk = LGd, 
    LSr_avg_spk = LSr,
    MOs_avg_spk = MOs, 
    SUB_avg_spk = SUB, 
    TH_avg_spk = TH,
    VISa_avg_spk = VISa, 
    VISp_avg_spk = VISp, 
    VPL_avg_spk = VPL
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)
print(trial.long)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the TH, VISp, and VPL panels, we can see that these brain regions experience a steep decline in its average spike counts from 0-200+ trials. One interesting feature of these plots here is that the MOs and VISa brain areas have very low average spike counts; whereas the SUB and LGd brain areas experience major average spike changes with numerous negative downward trends. What we have already seen that is that Forssmann's success rate is already pretty high and this makes us wonder if the relatively stable fluctations and somewhat decreasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the TH brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. However, the LD brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. There is a contradiction in our arguments in this sessions as the VISa has a stable average spike count but has a negative correlation. It is quite difficult to make conclusions as there is no clear relationship. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=4 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 4

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(4,this_session = session[[i.s]])

```

```{r, include = FALSE, echo = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 4

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 4

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 4

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 4 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the VPl, VISp, and LGd brain areas generally have higher average spikes and this is seen throughout trials 1-249; whereas the MOs brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the MOs brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the MOs and the CA1 brain area have mirroring patterns in average spike counts over the course of session 4. 

--- 

```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 4

# Loop through each trial
for (i.t in 1:249) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, include = FALSE, echo = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 4

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 4

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = ACA, y = feedback, colour = "red")) +
  xlab("ACA") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA1, y = feedback, colour = "red")) +
  xlab("CA1") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = DG, y = feedback, colour = "red")) +
  xlab("DG") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = LGd, y = feedback, colour = "red")) +
  xlab("LGd") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = LSr, y = feedback, colour = "red")) +
  xlab("LSr") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = MOs, y = feedback, colour = "red")) +
  xlab("MOs") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = SUB, y = feedback, colour = "red")) +
  xlab("SUB") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = TH, y = feedback, colour = "red")) +
  xlab("TH") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p9 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISa, y = feedback, colour = "red")) +
  xlab("VISa") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p10 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISp, y = feedback, colour = "red")) +
  xlab("VISp") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p11 = ggplot() +

  geom_line(data = trial.summary, aes(x = VPL, y = feedback, colour = "red")) +
  xlab("VPL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, nrow = 4)

```
There are 11 plots that provide an understanding of what is taking place in each of the 11 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Forssmann makes a decision as to what contrast to choose. We can go back to our correlation bar graph and find some connections here. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting no obvious relationship between the average spike count and feedback, which affirms our findings from the correlation bar graphs.


---


```{r, echo= FALSE, include = FALSE}
i.s = 4

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "DG", "LGd", "LSr", "MOs", "SUB", "TH", "VISa", "VISp", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 11 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the ACA and VISp brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the MOs and VISa regions, where the average spike count for negative feedback is more spread out. 

```{r, echo= FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "DG", "LGd", "LSr", "MOs", "SUB", "TH", "VISa", "VISp", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e MOs and VPL brain areas). 


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_4 <- get_session_data(4)
head(session_4)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_4)) {
  session_4$stimuli_condition <- factor(paste(session_4$contrast_left, session_4$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_4, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Forssmann was faced with 1-1, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0 and 0-0.25. However, there were some cases where the opposite turned out to be the case. For example, in the 0.25-0.5 case, there was a decrease in average spike counts across trials with negative feedback. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes tend to result in decreasing neural activity on average despite great fluctuations, while failures tend to result in increasing or stable neural activity for the most part. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_4 <- get_session_data(4)
head(session_4)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_4 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 249 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Forssmann ends this session with many failures which is also the case for Cori.

# Session 5 Base Evaluation (Mouse: Forssmann)
```{r}
session5 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session5.rds")
names(session5)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 254 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r}
session[[5]]$mouse_name

summary(session[[5]]$brain_area)
table(session[[5]]$brain_area)

summary(session[[5]]$contrast_left)
table(session[[5]]$contrast_left)
length(session[[5]]$contrast_left)

summary(session[[5]]$contrast_right)
table(session[[5]]$contrast_right)
length(session[[5]]$contrast_right)

summary(session[[5]]$feedback_type)
table(session[[5]]$feedback_type)
length(session[[5]]$feedback_type)

```
This session also evaluates mouse Forssmann's behavior and subsequent neural activity. There are 1077 neurons found in 10 brain areas: ACA (53 neurons), CA1 (28 neurons), DG (16 neurons), MOs (29 neurons), OLF (181 neurons), ORB (32 neurons), PL (14 neurons), root (524 neurons), SUB (101 neurons), VISa (99 neurons). There are 254 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 86 trials resulted in a failure and 168 trials resulted in a success out of a total of 254 trials. Another way to look at that success-failure outcome is as follows: 33.86% of the the trials resulted in a failure; 66.14% of the trials resulted in a success. So far, just be looking at the success/failure rate in this session, mouse Forssmann did not demonstrate improvement in performance. It would be rather important to note that mouse Cori had considerable improvement in his ability to make decisions based on the visual stimuli per session, but from so far not the case for mouse Forssmann. With these explorations, we must also explore Forssmann's performance over the 254 trials and see if there were any gradual improvements over time within just this session. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 254 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the left side: 0 was chosen 112 times, 0.25 was chosen 46 times, 0.5 was chosen 43 times, and 1 was chosen 53 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0.25, which is also on the lower end and was the same as the median of choosing a contrast left value. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Forssmann was equally inclined to choosing a lower contrast left and right value. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the right side: 0 was chosen 105 times, 0.25 was chosen 48 times, 0.5 was chosen 45 times, and 1 was chosen 56 times. 

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 



# Data Analysis

```{r, echo = FALSE, include = FALSE}
n.session=5

i = 5

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss5_trial_data <- data.frame(
  trial_id = 1:254
)

trial_outcome_vector <- as.vector(session[[5]]$feedback_type[, 1])

ss5_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss5_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 5. From our base evaluation from sessions 1-3 (Mouse: Cori) and session 4 (Mouse: Forssmann), we know that Forssmann's success rate in this session is close to Cori's last session, if we would like to think that Cori has improved over the sessions, then it is impressive that Forssmann has started off this high in his first two sessions. There are a lot less successive successes in the middle of this session.The successive successes are a lot more frequent in this session compared to the successive failures. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=5 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 5

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(5,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 5.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in sessions 1-2. It is also important to note that some of these brain areas with the lower average spike count haven't been evaluated before, such as the OLF and ORB regions. 

The average spike counts in the root brain area is relatively stable with small dips in spikes in between trials. This is interesting because all brain areas experience a common dip in average spikes at about the 200th trial mark. The DG and ORB brain regions experience the most fluctuations in its relative lines, while the PL brain area is the only region with an increasing average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=5 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 5

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(5,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    ACA_avg_spk = ACA, 
    CA1_avg_spk = CA1, 
    DG_avg_spk = DG, 
    MOs_avg_spk = MOs, 
    OLF_avg_spk = OLF,
    ORB_avg_spk = ORB, 
    PL_avg_spk = PL, 
    root_avg_spk = root,
    SUB_avg_spk = SUB, 
    VISa_avg_spk = VISa
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the root and VISa panels, we can see that these brain regions experience a  decline in its average spike counts from 0-200+ trials. One interesting feature of these plots here is that the PL and ACA brain areas have very low average spike counts; whereas the SUB and DG brain areas experience major average spike changes with numerous negative downward trends. What we have already seen that is that Forssmann's success rate is already pretty high and this makes us wonder if the relatively stable fluctations and somewhat decreasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the root brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. However, the ACA brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. There is a contradiction in our arguments in this sessions as the MOs has a stable average spike count but has a negative correlation. It is quite difficult to make conclusions as there is no clear relationship. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=5 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 5

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(5,this_session = session[[i.s]])

```

```{r, include = FALSE, echo = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 5

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 5

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE, include = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 5

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 5 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the SUB, root, and DG brain areas generally have higher average spikes and this is seen throughout trials 1-254; whereas the OLF brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the OLF brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the ORB and the ACA brain area have mirroring patterns in average spike counts over the course of session 5. 

--- 

```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 5

# Loop through each trial
for (i.t in 1:254) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 5

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 5

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = ACA, y = feedback, colour = "red")) +
  xlab("ACA") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA1, y = feedback, colour = "red")) +
  xlab("CA1") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = DG, y = feedback, colour = "red")) +
  xlab("DG") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = MOs, y = feedback, colour = "red")) +
  xlab("MOs") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = OLF, y = feedback, colour = "red")) +
  xlab("OLF") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = ORB, y = feedback, colour = "red")) +
  xlab("ORB") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = PL, y = feedback, colour = "red")) +
  xlab("PL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p9 = ggplot() +

  geom_line(data = trial.summary, aes(x = SUB, y = feedback, colour = "red")) +
  xlab("SUB") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p10 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISa, y = feedback, colour = "red")) +
  xlab("VISa") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, nrow = 4)

```
There are 10 plots that provide an understanding of what is taking place in each of the 10 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Forssmann makes a decision as to what contrast to choose. We can go back to our correlation bar graph and find some connections here. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting no obvious relationship between the average spike count and feedback, which affirms our findings from the correlation bar graphs. However, the root brain area carries our preliminary convictions that there is a slight relationship between positive feedback and increasing average spike count.

---


```{r, echo = FALSE, include = FALSE}
i.s = 5

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "DG", "MOs", "OLF", "ORB", "PL", "root", "SUB", "VISa"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 10 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the ACA and DG brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the PL and PL regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "DG", "MOs", "OLF", "ORB", "PL", "root", "SUB", "VISa"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e ACA, PL and MOs brain areas). 


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_5 <- get_session_data(5)
head(session_5)
```

```{r, include = FALSE, echo = FALSE}
if (!"stimuli_condition" %in% names(session_5)) {
  session_5$stimuli_condition <- factor(paste(session_5$contrast_left, session_5$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_5, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Forssmann was faced with 1-1, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.25-0.5 and 1-0.5. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_5 <- get_session_data(5)
head(session_5)
```

```{r, echo = FALSE, include= FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_5 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 254 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Forssmann ends this session with many failures which is also the case for Cori.

# Session 6 Base Evaluation (Mouse: Forssmann)
```{r, echo = FALSE}
session6 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session6.rds")
names(session6)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 290 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[6]]$mouse_name

summary(session[[6]]$brain_area)
table(session[[6]]$brain_area)

summary(session[[6]]$contrast_left)
table(session[[6]]$contrast_left)
length(session[[6]]$contrast_left)

summary(session[[6]]$contrast_right)
table(session[[6]]$contrast_right)
length(session[[6]]$contrast_right)

summary(session[[6]]$feedback_type)
table(session[[6]]$feedback_type)
length(session[[6]]$feedback_type)

```
This session also evaluates mouse Forssmann's behavior and subsequent neural activity. There are 1169 neurons found in 5 brain areas: AUD (246 neurons), CA1 (36 neurons), root (628 neurons), SSp (11 neurons), TH (248 neurons). There are 290 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 75 trials resulted in a failure and 215 trials resulted in a success out of a total of 290 trials. Another way to look at that success-failure outcome is as follows: 33.86% of the the trials resulted in a failure; 66.14% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Forssmann, we can say that Forssmann's performance and ability to make decisions based on the visual stimuli is improving! Despite this not being the case from session 4 to session 5, the session 5 to session 6 statistics are a bit more promising in understanding Forssmann's ability to make informed decisions based on the visual stimuli.With these explorations, we must also explore Forssmann's performance over the 290 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 290 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the left side: 0 was chosen 122 times, 0.25 was chosen 52 times, 0.5 was chosen 53 times, and 1 was chosen 63 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0.25, which is also on the lower end and was the same as the median of choosing a contrast left value. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Forssmann was equally inclined to choosing a lower contrast left and right value. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the right side: 0 was chosen 125 times, 0.25 was chosen 59 times, 0.5 was chosen 53 times, and 1 was chosen 53 times as well.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the right side, 0.5 was chosen at about the same frequency, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 




# Data Analysis

```{r, echo = FALSE , include = FALSE}
n.session=6

i = 6

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss6_trial_data <- data.frame(
  trial_id = 1:290
)

trial_outcome_vector <- as.vector(session[[6]]$feedback_type[, 1])

ss6_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss6_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 6. From our base evaluation from sessions 1-3 (Mouse: Cori), and from sessions 4-5 (Mouse: Forssmann) we know that Forssmann's success rate in this session is higher than in any of Cori's sessions and Forssmann's sessions thus far. There are a lot less successive successes in the middle of this session.The successive successes are a lot more frequent in this session compared to the successive failures. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=6 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 6

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(6,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 6.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in sessions 1-2. It is also important to note that some of these brain areas with the lower average spike count haven't been evaluated before, such as the AUD and SSp regions.  

The average spike counts in the root brain area is relatively stable with small dips in spikes in between trials. This is interesting because all brain areas experience a common dip in average spikes at about the 140th and 210th trial mark. The root and SSp brain regions experience the most fluctuations in its relative lines. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate (as this session had a higher success rate than in any of Cori's sessions.)

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=6 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 6

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(6,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    AUD_avg_spk = AUD, 
    CA1_avg_spk = CA1, 
    root_avg_spk = root, 
    SSp_avg_spk = SSp, 
    TH_avg_spk = TH,
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the TH panel, we can see that this brain region experience a steep decline in its average spike counts from 0-250+ trials. One interesting feature of these plots here is that the CA1 brain area has very low average spike counts; whereas the root brain area experiences major average spike changes with numerous negative and positive downward trends. What we have already seen that is that Forssmann's success rate is already pretty high and this makes us wonder if the relatively stable fluctuations and somewhat decreasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the TH brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. However, the AUD brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=6 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 6

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(6,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 6

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 6

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 6

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 6 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the CA1 and root brain areas generally have higher average spikes and this is seen throughout trials 1-290; whereas the MOs brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the TH brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the TH and the AUD brain area have mirroring patterns in average spike counts over the course of session 6. 

--- 

```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 6

# Loop through each trial
for (i.t in 1:290) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 6

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 6

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = AUD, y = feedback, colour = "red")) +
  xlab("AUD") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA1, y = feedback, colour = "red")) +
  xlab("CA1") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = SSp, y = feedback, colour = "red")) +
  xlab("SSp") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = TH, y = feedback, colour = "red")) +
  xlab("TH") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 



grid.arrange(p1, p2, p3, p4, p5, nrow = 4)

```
There are 5 plots that provide an understanding of what is taking place in each of the 5 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Forssmann makes a decision as to what contrast to choose. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting very weak relationships between the average spike count and feedback, which affirms our findings from the correlation bar graphs.

---


```{r, echo = FALSE, include = FALSE}
i.s = 6

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("AUD", "CA1", "root", "SSp", "TH"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 5 brain areas, it can be seen that negative feedback leads to a somewhat tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the AUD, SSp, and TH brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the root and SSp regions, where the average spike count for negative feedback is more spread out. 

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("AUD", "CA1", "root", "SSp", "TH"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e CA1 and AUD brain areas). 


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_6 <- get_session_data(6)
head(session_6)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_6)) {
  session_6$stimuli_condition <- factor(paste(session_6$contrast_left, session_6$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_6, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Forssmann was faced with 1-1, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0 and 0-0.25. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_6 <- get_session_data(6)
head(session_6)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_6 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 290 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Forssmann ends this session with many failures which is also the case for Cori and Forssmann's previous sessions. (Note that Forssmann's last trial ends in a success but there is a trend of failures in the end, besides that 1 last trial.)

# Session 7 Base Evaluation (Mouse: Forssmann)
```{r, echo = FALSE}
session7 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session7.rds")
names(session7)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 252 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[7]]$mouse_name

summary(session[[7]]$brain_area)
table(session[[7]]$brain_area)

summary(session[[7]]$contrast_left)
table(session[[7]]$contrast_left)
length(session[[7]]$contrast_left)

summary(session[[7]]$contrast_right)
table(session[[7]]$contrast_right)
length(session[[7]]$contrast_right)

summary(session[[7]]$feedback_type)
table(session[[7]]$feedback_type)
length(session[[7]]$feedback_type)

```
This session also evaluates mouse Forssmann's behavior and subsequent neural activity. There are 584 neurons found in 8 brain areas: CA3 (130 neurons), CP (59 neurons), EPd (52 neurons), LD (42 neurons), PIR (67 neurons), root (89 neurons), SSp (39 neurons), VPL (106 neurons). There are 252 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 83 trials resulted in a failure and 169 trials resulted in a success out of a total of 252 trials. Another way to look at that success-failure outcome is as follows: 32.94% of the the trials resulted in a failure; 67.06% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Forssmann, we can say that Forssmann's performance and ability to make decisions based on the visual stimuli is quite stagnant. I say this because, though the failure rate decreased by 7.08%, the success rate also decreased by 7.08% from session 6 to session 7. Unlike mouse Cori who demonstrated gradual improvements, Forssmann does not demonstrate the same. With these explorations, we must also explore Forssmann's performance over the 252 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 252 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the left side: 0 was chosen 120 times, 0.25 was chosen 46 times, 0.5 was chosen 47 times, and 1 was chosen 39 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0.25, which is also on the lower end and was the same as the median of choosing a contrast left value. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Forssmann was equally inclined to choosing a lower contrast left and right value. Here are the frequency statistics that indicate how often Forssmann chose a specific contrast level on the right side: 0 was chosen 119 times, 0.25 was chosen 38 times, 0.5 was chosen 45 times, and 1 was chosen 50 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.  



# Data Analysis

```{r, echo = FALSE, include = FALSE}
n.session=7

i = 7

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss7_trial_data <- data.frame(
  trial_id = 1:252
)

trial_outcome_vector <- as.vector(session[[7]]$feedback_type[, 1])

ss7_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss7_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 7. From our base evaluation from sessions 1-3 (Mouse: Cori) and sessions 4-6 (Mouse: Forssmann), we know that Forssmann's success rate in this session is a lot lower but still higher than in any of Cori's sessions. There are a lot less successive successes in the middle of this session and a lot more patterns of success/fail/success/etc. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=7 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 7

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(7,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 7.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in sessions 1-2, but a lot higher than in Forssmann's previous sessions. It is also important to note that some of these brain areas haven't been evaluated before, such as the EPd and PIR regions. 

The average spike counts in the root brain area is relatively stable with a common decrease at the end. The PIR, CP, and SSp brain regions experience the most fluctuations in its relative lines, while the EPd and LD brain areas are the only regions with an increasing average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=7 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 7

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(7,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA3_avg_spk = CA3, 
    CP_avg_spk = CP, 
    EPd_avg_spk = EPd, 
    LD_avg_spk = LD, 
    PIR_avg_spk = PIR,
    root_avg_spk = root, 
    SSp_avg_spk = SSp, 
    VPL_avg_spk = VPL
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the CA3 and SSp panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the EPd, LD, and PIR brain areas experience steady increases in its average spike count over the course of the session. It is also interesting to look into the CP brain area as it experiences a sudden increase in average spike counts early on in the session. What we have already seen that is that Forssmann's success rate is already pretty high and this makes us wonder if the relatively stable fluctations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the SSp brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. However, the PIR brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. There is a contradiction in our arguments in this sessions as the EPd has an increasing average spike count but has a negative correlation. This would mean that an increasing average spike count correlates with negative feedback.

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=7 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 7

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(7,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 7

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 7

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 7

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 7 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LD, root, and VPL brain areas generally have higher average spikes and this is seen throughout trials 1-252; whereas the EPd brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the Epd brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the VPL and the root brain area have mirroring patterns in average spike counts over the course of session 7. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 7

# Loop through each trial
for (i.t in 1:252) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 7

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 7

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}

library(gridExtra)

# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA3, y = feedback, colour = "red")) +
  xlab("CA3") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CP, y = feedback, colour = "red")) +
  xlab("CP") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = EPd, y = feedback, colour = "red")) +
  xlab("EPd") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = LD, y = feedback, colour = "red")) +
  xlab("LD") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = PIR, y = feedback, colour = "red")) +
  xlab("PIR") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = SSp, y = feedback, colour = "red")) +
  xlab("SSp") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = VPL, y = feedback, colour = "red")) +
  xlab("VPL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, nrow = 4)

```
There are 10 plots that provide an understanding of what is taking place in each of the 8 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Forssmann makes a decision as to what contrast to choose. We can go back to our correlation bar graph and find some connections here. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting no obvious relationship between the average spike count and feedback, which affirms our findings from the correlation bar graphs.

---


```{r, echo = FALSE, include = FALSE}
i.s = 7

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA3", "CP", "EPd", "LD", "PIR", "root", "SSp", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 10 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the CP and PIR brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the PIR and SSp regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA3", "CP", "EPd", "LD", "PIR", "root", "SSp", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e EPd, PIR and SSp brain areas). 


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_7 <- get_session_data(7)
head(session_7)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_7)) {
  session_7$stimuli_condition <- factor(paste(session_7$contrast_left, session_7$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_7, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Forssmann was faced with 1-1, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-0.5. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_7 <- get_session_data(7)
head(session_7)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_7 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 252 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Forssmann ends this session with many failures which is also the case for Cori.

# Session 8 Base Evaluation (Mouse: Hench)
```{r, echo = FALSE}
session8 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session8.rds")
names(session8)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 250 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[8]]$mouse_name

summary(session[[8]]$brain_area)
table(session[[8]]$brain_area)

summary(session[[8]]$contrast_left)
table(session[[8]]$contrast_left)
length(session[[8]]$contrast_left)

summary(session[[8]]$contrast_right)
table(session[[8]]$contrast_right)
length(session[[8]]$contrast_right)

summary(session[[8]]$feedback_type)
table(session[[8]]$feedback_type)
length(session[[8]]$feedback_type)

```
This is the first session that evaluated mouse Hench's behavior and subsequent neural activity. There are 1157 neurons found in 15 brain areas: CA1 (56 neurons), CA3 (17 neurons), DG (33 neurons), ILA (144 neurons), LD (41 neurons), LP (120 neurons), LSr (3 neurons), MOs (113 neurons), PL (144 neurons), PO (255 neurons), root (4 neurons), SUB (34 neurons), TT (82 neurons), VISa (63 neurons), VISp (48 neurons). There are 250 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 89 trials resulted in a failure and 161 trials resulted in a success out of a total of 250 trials. Another way to look at that success-failure outcome is as follows: 35.6% of the the trials resulted in a failure; 64.4% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Hench from his first session, we can say that Hench's performance and ability to make decisions based on the visual stimuli is higher than Cori's first session but lower than Forssmann's first session. With these explorations, we must also explore Hench's performance over the 250 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 250 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 94 times, 0.25 was chosen 40 times, 0.5 was chosen 31 times, and 1 was chosen 85 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is quite high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Hench was more inclined to choosing a lower contrast left than right value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 100 times, 0.25 was chosen 47 times, 0.5 was chosen 38 times, and 1 was chosen 63 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 




# Data Analysis

```{r, echo = FALSE}
n.session=8

i = 8

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss8_trial_data <- data.frame(
  trial_id = 1:250
)

trial_outcome_vector <- as.vector(session[[8]]$feedback_type[, 1])

ss8_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss8_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 8. From our base evaluation from sessions 1-3 (Mouse: Cori), and from sessions 4-7 (Mouse: Forssmann) we know that Hench's is quite high, though not as high as any of Forssmann's sessions. There are a lot less successive successes in the middle of this session.The successive successes are a lot more frequent in this session compared to the successive failures. Similarly to Cori and Forssmann, Hench finishes the session off with many failures. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=8 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 8

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(8,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 8.


```{r, echo = FALSE}
area.col = rainbow(n = n.area, alpha = 0.7)
# Initiating a blank plot with specified x and y limits to 'zoom in'
plot(x = 1, y = 0, col = 'white',
     xlim = c(0, 250),  # Zoom in to show only trials 50 to 100
     ylim = c(-0.5, 5),  # Zoom in to show average spike counts from 0.5 to 1.5
     xlab = "Trials", ylab = "Average spike counts",
     main = paste("Spikes per area in Session", i.s))

# Loop over each area and plot lines
for(i in 1:n.area){
  lines(y = trial.summary[[i]], x = trial.summary$id, col = area.col[i], lty = 2, lwd = 1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]), col = area.col[i], lwd = 3)
}

# Add a legend to the plot
legend("topright", 
       legend = colnames(trial.summary)[1:n.area], 
       col = area.col, 
       lty = 1, 
       cex = 0.8
)


```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot higher than the ones we have seen in previous sessions. It is also important to note that some of these brain areas with the lower average spike count haven't been evaluated before, such as the ILA region.  

The average spike counts in most of the brain areas experience frequent dips in between trials. This is interesting because all brain areas experience a common dip in average spikes at about the 190th trial mark. The PO and VISa brain regions experience the most fluctuations in its relative lines. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate (as this session had a higher success rate than in any of Cori's sessions.) From the conclusions we tried to draw regarding correlation between feedback and average spike count activity, it will be interesting to see what the relationship is like in this particular session. 


```{r, echo= FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=8 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 8

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(8,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA1_avg_spk = CA1, 
    CA3_avg_spk = CA3, 
    DG_avg_spk = DG, 
    ILA_avg_spk = ILA, 
    LD_avg_spk = LD,
    LP_avg_spk = LP, 
    LSr_avg_spk = LSr, 
    MOs_avg_spk = MOs, 
    PL_avg_spk = PL, 
    PO_avg_spk = PO, 
    root_avg_spk = root, 
    SUB_avg_spk = SUB, 
    TT_avg_spk = TT, 
    VISa_avg_spk = VISa, 
    VISp_avg_spk = VISp
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the SUB panel, we can see that this brain region experience a relatively steep decline in its average spike counts from 0-250+ trials. One interesting feature of these plots here is that the LSr brain area has very low average spike counts; whereas the VISa brain area experiences major average spike changes with numerous negative and positive downward trends. What we have already seen that is that Hench's success rate is already pretty high and this makes us wonder if the relatively stable fluctuations and somewhat decreasing average spike counts could predict or even correlate with a success/failure in the decision making process (and vise versa). We will explore this next. 


```{r, echo= FALSE}
library(tidyverse)
library(ggplot2)

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions, in certain cases. There is rather a very slight relationship between the two. This is similar to how our assumptions from the last sessions were debunked. However, it is imperative to look at this relationship on a brain region by region basis. For example, the majority of brain areas experience decreasing average spike counts and have a positive correlation, indicating that there is a relationship - though slight - between decreasing average spike counts and negative feedback. On the contrary, there is a different relationship between CA3 average spike counts and feedback. Since it also has a positive correlation, this would indicate that an increasing average spike count would indicate a success in the decision making process. 


```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=8 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 8

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(8,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 8

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 8

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 8

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 8 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LSr brain area generally has moments with higher average spikes and this is seen throughout trials 1-250; whereas the root brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the root brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the MOs and the DG brain area have mirroring patterns in average spike counts over the course of session 8. 

--- 

```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 8

# Loop through each trial
for (i.t in 1:250) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 8

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 8

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
# Plotting the trend of feedback per brain area


p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA1, y = feedback, colour = "red")) +
  xlab("CA1") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA3, y = feedback, colour = "red")) +
  xlab("CA3") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = DG, y = feedback, colour = "red")) +
  xlab("DG") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p4 = ggplot() +

  geom_line(data = trial.summary, aes(x = ILA, y = feedback, colour = "red")) +
  xlab("ILA") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = LD, y = feedback, colour = "red")) +
  xlab("LD") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = LP, y = feedback, colour = "red")) +
  xlab("LP") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = LSr, y = feedback, colour = "red")) +
  xlab("LSr") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = MOs, y = feedback, colour = "red")) +
  xlab("MOs") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 


grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, nrow = 4)

```

```{r, echo = FALSE}
p9 = ggplot() +

  geom_line(data = trial.summary, aes(x = PL, y = feedback, colour = "red")) +
  xlab("PL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p10 = ggplot() +

  geom_line(data = trial.summary, aes(x = PO, y = feedback, colour = "red")) +
  xlab("PO") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p11 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p12 = ggplot() +

  geom_line(data = trial.summary, aes(x = SUB, y = feedback, colour = "red")) +
  xlab("SUB") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p13 = ggplot() +

  geom_line(data = trial.summary, aes(x = TT, y = feedback, colour = "red")) +
  xlab("TT") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p14 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISa, y = feedback, colour = "red")) +
  xlab("VISa") +
  ylab("Feedback") +
  ggtitle("Feedback Trends") 

p15 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISp, y = feedback, colour = "red")) +
  xlab("VISp") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

grid.arrange(p9, p10, p11, p12, p13, p14, p15, nrow = 4)

```


There are 15 plots that provide an understanding of what is taking place in each of the 15 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Hench makes a decision as to what contrast to choose. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting very weak relationships between the average spike count and feedback, which affirms our findings from the correlation bar graphs. However, the root brain area is a special case where there seems to be a relationship between feedback and brain area. It can be seen that there is a positive relation between feedback and increasing average spike counts, despite a weak correlation value. 

---


```{r, echo = FALSE, include = FALSE}
i.s = 8

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "CA3", "DG", "ILA", "LD", "LP", "LSr", "MOs", "PL", "PO", "root", "SUB", "TT", "VISa", "VISp"),
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 15 brain areas, it can be seen that negative feedback leads to a somewhat tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. This is a continual finding from the previous sessions. There are some exceptions in the MOs and SUB regions, where the average spike count for negative feedback is more spread out. 

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "CA3", "DG", "ILA", "LD", "LP", "LSr", "MOs"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("PL", "PO", "root", "SUB", "TT", "VISa", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("LSr"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```

Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers, especially in the LSr brain area.

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_8 <- get_session_data(8)
head(session_8)
```


```{r, echo = FALSE}
ggplot(session_8, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major spikes that is uncharacteristic to its normal patterns, though positive feedback has some non-normal patterns in comparison to previous sessions. 



Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo= FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_8 <- get_session_data(8)
head(session_8)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_8)) {
  session_8$stimuli_condition <- factor(paste(session_8$contrast_left, session_8$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_8, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 1-1, one success/failure after another led to an increase in average spike counts. This can also be seen in the cases 0.5-1 and 0.25-0.25. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_8 <- get_session_data(8)
head(session_8)
```

```{r, echo= FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_8 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 250 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Forssmann ends this session with many failures which is also the case for Cori and Forssmann's sessions.

# Session 9 Base Evaluation (Mouse: Hench)
```{r, echo= FALSE}
session9 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session9.rds")
names(session9)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 372 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[9]]$mouse_name

summary(session[[9]]$brain_area)
table(session[[9]]$brain_area)

summary(session[[9]]$contrast_left)
table(session[[9]]$contrast_left)
length(session[[9]]$contrast_left)

summary(session[[9]]$contrast_right)
table(session[[9]]$contrast_right)
length(session[[9]]$contrast_right)

summary(session[[9]]$feedback_type)
table(session[[9]]$feedback_type)
length(session[[9]]$feedback_type)

```
This session also evaluates mouse Hench's behavior and subsequent neural activity. There are 788 neurons found in 12 brain areas: CA1 (90 neurons), CA3 (86 neurons), LD (79 neurons), ORBm (122 neurons), PL (50 neurons), root (6 neurons), TH (52 neurons), TT (55 neurons), VISam (38 neurons), VISl (104 neurons), VPL (73 neurons) . There are 372 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 117 trials resulted in a failure and 255 trials resulted in a success out of a total of 372 trials. Another way to look at that success-failure outcome is as follows: 31.45% of the the trials resulted in a failure; 68.55% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Hench, we can say that Hench's performance and ability to make decisions based on the visual stimuli is improving from session to session! With these explorations, we must also explore Hench's performance over the 372 trials and see if there were any gradual improvements over time within just this session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 372 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 153 times, 0.25 was chosen 45 times, 0.5 was chosen 68 times, and 1 was chosen 106 times.  One interesting discovery here is that the median of choosing a contrast left value was 0, which is very low. We will need to take a deeper look into what this may mean and its implications for its success rate (as this is the first median of 0 among all sessions) 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is quite high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Hench was more inclined to choosing a lower contrast right than left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 193 times, 0.25 was chosen 74 times, 0.5 was chosen 48 times, and 1 was chosen 57 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 



# Data Analysis

```{r, echo = FALSE}
n.session=9

i = 9

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss9_trial_data <- data.frame(
  trial_id = 1:372
)

trial_outcome_vector <- as.vector(session[[9]]$feedback_type[, 1])

ss9_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss9_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 9. From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and session 8 (Mouse: Hench), we know that Hench's success rate improves from one session to the next, which has been a common trend among all mice thus far. There are a lot more successive successes in the middle of this session and a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=9 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 9

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(9,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 9.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are on par with the ones we have seen in sessions 1-2, but a lot higher than in Forssmann's sessions. It is also important to note that some of these brain areas haven't been evaluated before, such as the ORBm region. 

The average spike counts in the ORBm brain area is relatively stable with a common decrease at the end shared with other brain areas. The CA1, TT, and LD brain regions experience the most fluctuations in its relative lines, while the root and LD brain areas are the only regions with a decreasing average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=9 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 9

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(9,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA1_avg_spk = CA1,
    CA3_avg_spk = CA3, 
    LD_avg_spk = LD,
    LSr_avg_spk = LSr,
    ORBm_avg_spk = ORBm, 
    PL_avg_spk = PL, 
    root_avg_spk = root,
    TH_avg_spk = TH, 
    TT_avg_spk = TT, 
    VISam_avg_spk = VISam,
    VISl_avg_spk = VISl, 
    VPL_avg_spk = VPL
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the CA3 and SSp panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the LD brain area experiences steady increases in its average spike count over the course of the session.  What we have already seen that is that Hench's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 9

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the root brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. However, the LD brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions.

```{r, echo = FALSE}
# Find the average number of spikes across neurons in each area

i.s=9 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 9

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(9,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 9

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 9

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 9

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 9 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LD and VPL brain areas generally have higher average spikes and this is seen throughout trials 1-372; whereas the ORBm brain area has a lower average spike count over the course of the session. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the ORBm brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the TH and the CA1 brain area have mirroring patterns in average spike counts over the course of session 9. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 9

# Loop through each trial
for (i.t in 1:372) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 9

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 9

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(ggplot2)
library(gridExtra)

# Plotting the trend of feedback per brain area
p1 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA1, y = feedback, colour = "red")) +
  xlab("CA1") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p2 = ggplot() +

  geom_line(data = trial.summary, aes(x = CA3, y = feedback, colour = "red")) +
  xlab("CA3") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p3 = ggplot() +

  geom_line(data = trial.summary, aes(x = LD, y = feedback, colour = "red")) +
  xlab("LD") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p4= ggplot() +

  geom_line(data = trial.summary, aes(x = LSr, y = feedback, colour = "red")) +
  xlab("LSr") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p5 = ggplot() +

  geom_line(data = trial.summary, aes(x = ORBm, y = feedback, colour = "red")) +
  xlab("ORBm") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p6 = ggplot() +

  geom_line(data = trial.summary, aes(x = PL, y = feedback, colour = "red")) +
  xlab("PL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 4)

```

```{r, echo = FALSE}
p7 = ggplot() +

  geom_line(data = trial.summary, aes(x = root, y = feedback, colour = "red")) +
  xlab("root") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p8 = ggplot() +

  geom_line(data = trial.summary, aes(x = TH, y = feedback, colour = "red")) +
  xlab("TH") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p9 = ggplot() +

  geom_line(data = trial.summary, aes(x = TT, y = feedback, colour = "red")) +
  xlab("TT") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p10 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISam, y = feedback, colour = "red")) +
  xlab("VISam") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p11 = ggplot() +

  geom_line(data = trial.summary, aes(x = VISl, y = feedback, colour = "red")) +
  xlab("VISl") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 

p12 = ggplot() +

  geom_line(data = trial.summary, aes(x = VPL, y = feedback, colour = "red")) +
  xlab("VPL") +
  ylab("Feedback") +
  ggtitle("Feedback Trends per Brain Area") 


grid.arrange(p7, p8, p9, p10, p11, p12, nrow = 4)

```

There are 12 plots that provide an understanding of what is taking place in each of the 12 brain areas in this session. What these plots intend to look at are the various neural activities that are taking place mouse as Hench makes a decision as to what contrast to choose. There doesn't appear to be a clear trend in the data from these panels. If there was a trend, the lines might slope upwards or downwards. Instead, they are horizontal, suggesting very weak relationships between the average spike count and feedback, which affirms our findings from the correlation bar graphs. However, the root brain area is a special case where there seems to be a relationship between feedback and brain area. It can be seen that there is a positive relation between feedback and increasing average spike counts, despite a weak correlation value. 


```{r, echo = FALSE, include = FALSE}
i.s = 9

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "CA3", "LD", "LSr", "ORBm", "PL", "root", "TH", "TT", "VISam", "VISl", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 12 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the CA1 and VISam brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the CA3 and VISl regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "CA3", "LD", "LSr", "ORBm", "PL", "root", "TH", "TT", "VISam", "VISl", "VPL"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e CA3, TT and VISl brain areas). 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_9 <- get_session_data(9)
head(session_9)
```


```{r, echo = FALSE}
ggplot(session_9, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major spikes that is uncharacteristic to its normal patterns. 


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_9 <- get_session_data(9)
head(session_9)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_9)) {
  session_9$stimuli_condition <- factor(paste(session_9$contrast_left, session_9$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_9, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-0.5. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_9 <- get_session_data(9)
head(session_9)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_9 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 372 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Hench ends this session with many failures which is also the case for Cori and Forssmann.

# Session 10 Base Evaluation (Mouse: Hench)
```{r, echo= FALSE}
session10 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session10.rds")
names(session10)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 447 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[10]]$mouse_name

summary(session[[10]]$brain_area)
table(session[[10]]$brain_area)

summary(session[[10]]$contrast_left)
table(session[[10]]$contrast_left)
length(session[[10]]$contrast_left)

summary(session[[10]]$contrast_right)
table(session[[10]]$contrast_right)
length(session[[10]]$contrast_right)

summary(session[[10]]$feedback_type)
table(session[[10]]$feedback_type)
length(session[[10]]$feedback_type)

```
This session also evaluates mouse Hench's behavior and subsequent neural activity. There are 1172 neurons found in 13 brain areas: CA1 (75 neurons), DG (73 neurons), GPe (63 neurons), MB (275 neurons), MRN (72 neurons), POL (154 neurons), POST (41 neurons), root (36 neurons), SCm (19 neurons), VISl (99 neurons), VISp (105 neurons), VISrl (136 neurons). There are 447 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 170 trials resulted in a failure and 277 trials resulted in a success out of a total of 447 trials. Another way to look at that success-failure outcome is as follows: 38.03% of the the trials resulted in a failure; 50.78% of the trials resulted in a success. By looking at these numbers, it seems that Hench has experienced ... after an initial improvement. The success rate for the session is the lowest among all sessions thus far and we must do more exploratory analysis to understand this session even more. With these explorations, we must also explore Hench's performance over the 447 trials and see if there were any gradual improvements over time within just this session. It would be interesting to see if there any declines in improvement over the trials, which would possibly explain the low success rate. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 447 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 193 times, 0.25 was chosen 60 times, 0.5 was chosen 74 times, and 1 was chosen 120 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is quite low. We will need to take a deeper look into what this may mean and its implications for its success rate.

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0, which is very low Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Hench was more inclined to choosing a lower contrast left than right value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 245 times, 0.25 was chosen 73 times, 0.5 was chosen 53 times, and 1 was chosen 76 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.




# Data Analysis

```{r, echo = FALSE}
n.session=10

i = 10

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss10_trial_data <- data.frame(
  trial_id = 1:447
)

trial_outcome_vector <- as.vector(session[[10]]$feedback_type[, 1])

ss10_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss10_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 10. From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-9 (Mouse: Hench), we know that Hench's success rate improves from one session to the next, which has been a common trend among all mice thus far. However, this session is a lot different as Hench's success rate plummets significantly. This is a There are a lot more successive successes and failures throughout the sessions but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=10 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 10

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(10,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 10.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower with the ones we have seen in Cori and Hench's previous sessions, but on par with Forssmann's sessions. It is also important to note that some of these brain areas haven't been evaluated before, such as the GPe region. 

The average spike counts in the VISrl brain area is relatively stable with a common increase at the end shared with other brain areas. The root, VISl, and POL brain regions experience the most fluctuations in its relative lines, while the SCm and VISp brain areas are the only regions with a decreasing average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=10 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 10

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(10,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA1_avg_spk = CA1,
    DG_avg_spk = DG, 
    GPe_avg_spk = GPe,
    MB_avg_spk = MB,
    MRN_avg_spk = MRN, 
    POL_avg_spk = POL, 
    POST_avg_spk = POST,
    root_avg_spk = root, 
    SCm_avg_spk = SCm, 
    SCsg_avg_spk = SCsg,
    VISl_avg_spk = VISl,
    VISp_avg_spk = VISp, 
    VISrl_avg_spk = VISrl
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the CA3 and SSp panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the LD brain area experiences steady increases in its average spike count over the course of the session.  What we have already seen that is that Hench's success rate is already pretty low and this makes us wonder if the relatively decreasing fluctuations and somewhat decreasing average spike counts could predict or even correlate with a failure in the decision making process (and vise versa). We will explore this next. 

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 10

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the MRN brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. Furthermore, the GPe brain area has an increasing average spike count and a positive correlation, which would mean that increasing average spike counts over time correlate with positive feedback. However, there seems to be a special case that contradicts our argument. Looking at the root brain panel, there seems to be a decreasing average spike count but a negative correlation. This would indicate that decreasing average spike counts correlate with successes. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=10 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 10

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(10,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 10

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 10

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 10

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "purple", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 10 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the MB and VISl brain areas generally have higher average spikes and this is seen throughout trials 1-447; whereas the ORBm brain area has a lower average spike count over the course of the session. The root brain area is also interesting to look into as the average spike counts experience a sudden decline at about the 200th trial mark. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the DG brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the POST and the MRN brain area have mirroring patterns in average spike counts over the course of session 10. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 10

# Loop through each trial
for (i.t in 1:447) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 10

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 10

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```

```{r, echo = FALSE, include = FALSE}
i.s = 10

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "DG", "GPe", "MB", "MRN", "POL", "POST", "root", "SCm", "SCsg", "VISl", "VISrl"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 13 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the DG and root brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the CA1 and DG regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "DG", "GPe", "MB", "MRN", "POL", "POST", "root", "SCm", "SCsg", "VISl", "VISrl"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e CA1, DG and VISrl brain areas). 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_10 <- get_session_data(10)
head(session_10)
```


```{r, echo= FALSE}
ggplot(session_10, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_10 <- get_session_data(10)
head(session_10)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_10)) {
  session_10$stimuli_condition <- factor(paste(session_10$contrast_left, session_10$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_10, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.5, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_10 <- get_session_data(10)
head(session_10)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_10 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 447 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Hench ends this session with many failures which is also the case for Cori and Forssmann.

# Session 11 Base Evaluation (Mouse: Hench)
```{r, echo = FALSE}
session11 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session11.rds")
names(session11)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 342 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo= FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[11]]$mouse_name

summary(session[[11]]$brain_area)
table(session[[11]]$brain_area)

summary(session[[11]]$contrast_left)
table(session[[11]]$contrast_left)
length(session[[11]]$contrast_left)

summary(session[[11]]$contrast_right)
table(session[[11]]$contrast_right)
length(session[[11]]$contrast_right)

summary(session[[11]]$feedback_type)
table(session[[11]]$feedback_type)
length(session[[11]]$feedback_type)

```
This session also evaluates mouse Hench's behavior and subsequent neural activity. There are 857 neurons found in 6 brain areas: CP (275 neurons), LSc (72 neurons), LSr (4 neurons), MOp (447 neurons), PT (45 neurons), root (14 neurons). There are 342 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 70 trials resulted in a failure and 272 trials resulted in a success out of a total of 342 trials. Another way to look at that success-failure outcome is as follows: 20.47% of the the trials resulted in a failure; 79.53% of the trials resulted in a success. By looking at these numbers, Hench improved significantly from session 10 to session 11 (by a whopping 56.66%)!. The success rate for the session is the highest among all sessions thus far and we must do more exploratory analysis to understand this session even more. With these explorations, we must also explore Hench's performance over the 342 trials and see if there were any gradual or sudden improvements over time within just this session. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 342 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 159 times, 0.25 was chosen 50 times, 0.5 was chosen 62 times, and 1 was chosen 71 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is quite low. We will need to take a deeper look into what this may mean and its implications for its success rate.

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0, which is very low Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Hench was more inclined to choosing a lower contrast left value than right value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 173 times, 0.25 was chosen 47 times, 0.5 was chosen 53 times, and 1 was chosen 69 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.




# Data Analysis

```{r, echo = FALSE}
n.session=11

i = 11

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss11_trial_data <- data.frame(
  trial_id = 1:342
)

trial_outcome_vector <- as.vector(session[[11]]$feedback_type[, 1])

ss11_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss11_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 11. From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-9 (Mouse: Hench), we know that Hench's success rate improves from one session to the next, which has been a common trend among all mice thus far. However, the session was a lot different as Hench's success rate plummets significantly. However, in this session, Hench improved his performance by nearly 50%. This is a There are a lot more successive successes in the middle of the session but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=11 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 11

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(11,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```
This R chunk provides the average spike counts in each brain area from session 11.

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are an part with the ones we have seen in Cori and Hench's previous sessions, but a lot higher Forssmann's sessions. It is also important to note that some of these brain areas haven't been evaluated before, such as the LSc region. 

The average spike counts in the PT brain area is relatively stable with a common increase at the end shared with other brain areas. The LSr brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a decreasing average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=11 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 11

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(11,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CP_avg_spk = CP, 
    LSc_avg_spk = LSc, 
    LSr_avg_spk = LSr, 
    MOp_avg_spk = MOp, 
    PT_avg_spk = PT, 
    root_avg_spk = root
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the CP and MOp panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the LSr brain area experiences stability in its average spike count over the course of the session.  What we have already seen that is that Hench's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 11

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the CP brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo= FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=11 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 11

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(11,this_session = session[[i.s]])

```

```{r, echo = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 11

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 11

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 11

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 11 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LSr and root brain areas generally have higher average spikes and this is seen throughout trials 1-342; whereas the PT brain area has a lower average spike count over the course of the session. The LSr brain area is also interesting to look into as the average spike counts experience a sudden increase at about the 230th trial mark. These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the PT brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the MOp, LSc, and the OP brain area have mirroring patterns in average spike counts over the course of session 11. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 11

# Loop through each trial
for (i.t in 1:342) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 11

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 11

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo= FALSE}
library(ggplot2)
library(gridExtra)

# Convert feedback to a factor
trial.summary$feedback <- factor(trial.summary$feedback)

# List to store plots
plots_list <- list()

# Create a function to generate plots to avoid repetitive code
generate_plot <- function(data, xvar, title) {
  ggplot(data, aes_string(x = xvar, y = "feedback")) +
    geom_point(aes(color = feedback), alpha = 0.5) +  # Use points to represent individual data
    geom_smooth(method = "loess", se = FALSE, aes(color = feedback)) +  # Add a LOESS smoothed trend line
    scale_color_manual(values = c("1" = "green", "-1" = "red")) +  # Set colors for the feedback
    theme_minimal() +
    labs(x = xvar, y = "Feedback", title = title) +
    theme(legend.position = "none")  # Remove legend for clarity
}

# Generate plots for each brain area
brain_areas <- c("CP")
titles <- c("Feedback Trends CP")

for (i in seq_along(brain_areas)) {
  plots_list[[i]] <- generate_plot(trial.summary, brain_areas[i], titles[i])
}

# Arrange the plots in a grid
grid.arrange(grobs = plots_list, nrow = 1)

```


---


```{r, echo = FALSE, include = FALSE}
i.s = 11

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```

```{r, echo= FALSE, include = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CP", "LSc", "LSr", "MOp", "PT", "root"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 6 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the PT and root brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the PT and LSr regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CP", "LSc", "LSr", "MOp", "PT", "root"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e PT, LSr and root brain areas). This is the first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Hench's success rate increased by nearly 50% contributing to more un-normal behavior related to positive feedback. 

```{r, echo= FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE,  include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo= FALSE}
session_11 <- get_session_data(11)
head(session_11)
```


```{r, echo = FALSE}
ggplot(session_11, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_11 <- get_session_data(11)
head(session_11)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_11)) {
  session_11$stimuli_condition <- factor(paste(session_11$contrast_left, session_11$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_11, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE}
session_11 <- get_session_data(11)
head(session_11)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_11 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 342 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Hench ends this session with many failures which is also the case for Cori and Forssmann, but has a lot of successes clustered in between the failures. 

# Session 12 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session12 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session12.rds")
names(session12)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 340 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo= FALSE}
session[[12]]$mouse_name

summary(session[[12]]$brain_area)
table(session[[12]]$brain_area)

summary(session[[12]]$contrast_left)
table(session[[12]]$contrast_left)
length(session[[12]]$contrast_left)

summary(session[[12]]$contrast_right)
table(session[[12]]$contrast_right)
length(session[[12]]$contrast_right)

summary(session[[12]]$feedback_type)
table(session[[12]]$feedback_type)
length(session[[12]]$feedback_type)

```
This is the first session that evaluated mouse Lederberg's behavior and subsequent neural activity. There are 698 neurons found in 12 brain areas: ACA (16 neurons), CA1 (50 neurons), DG (65 neurons), LGd (11 neurons), LH (18 neurons), MD (126 neurons), MOs (6 neurons), PL (56 neurons), root (100 neurons), SUB (105 neurons), VISam (79 neurons), VISp (66 neurons). There are 340 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 89 trials resulted in a failure and 251 trials resulted in a success out of a total of 340 trials. Another way to look at that success-failure outcome is as follows: 26.18% of the the trials resulted in a failure; 73.82% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg from his first session, we can say that Lederberg's performance and ability to make decisions based on the visual stimuli is higher than all of the other mices' first session. Additionally, Lederberg's success rate was higher than any of Cori and Forssmann's session, and all of Hench's sessions except for his last one. With these explorations, we must also explore Lederberg's performance over the 340 trials and see if there were any gradual improvements over time within just this session. This is most certainly will be an interesting session to explore due to the high success rate especially in the mouse's first session.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 340 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 173 times, 0.25 was chosen 55 times, 0.5 was chosen 55 times, and 1 was chosen 57 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is quite high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Hench was more inclined to choosing a lower contrast right than left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 167 times, 0.25 was chosen 50 times, 0.5 was chosen 50 times, and 1 was chosen 73 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process. 





# Data Analysis

```{r, echo = FALSE}
n.session=12

i = 12

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss12_trial_data <- data.frame(
  trial_id = 1:340
)

trial_outcome_vector <- as.vector(session[[12]]$feedback_type[, 1])

ss12_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss12_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 12. From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench), we know that Lederberg's success rate is already pretty high and close to some of the mice's latter sessions. There are a lot more successive successes in the middle of the session but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=12 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE} 
# Wrapping up the function:

i.s = 12

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(12,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are an part with the ones we have seen in Cori and Hench's previous sessions, but a lot higher Forssmann's sessions. 

The average spike counts in the LH brain area is relatively stable with a common stabilization at the end shared with other brain areas. The CA1, LSr, and SUB brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=12 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 12

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(12,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo= FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    ACA_avg_spk = ACA, 
    CA1_avg_spk = CA1, 
    DG_avg_spk = DG, 
    LGd_avg_spk = LGd, 
    LH_avg_spk = LH,
    MD_avg_spk = MD, 
    MOs_avg_spk = MOs, 
    PL_avg_spk = PL, 
    root_avg_spk = root, 
    SUB_avg_spk = SUB, 
    VISam_avg_spk = VISam, 
    VISp_avg_spk = VISp
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the SUB panel, we can see that this brain region experiences a  decline in its average spike counts, whereas the ACA, CA1, and DG, etc brain areas experience stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 12

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the SUB brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=12 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 12

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(12,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 12

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 12

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 12

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 12 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LH and LGd brain areas generally have higher average spikes and this is seen throughout trials 1-340; whereas the MOs brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the MOs brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the VISam and the DG brain areas have mirroring patterns in average spike counts over the course of session 12. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 12

# Loop through each trial
for (i.t in 1:340) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE,include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 12

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 12

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 12 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the 12 brain areas in this session, in relation to feedbacl. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to negative feedback.


```{r, echo = FALSE, include = FALSE}
i.s = 12

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "LGd", "LH", "MD", "MOs", "PL", "root", "SUB", "VISam", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the 12 brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the MD and VISp brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the PT and LSr regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("ACA", "CA1", "LGd", "LH", "MD", "MOs", "PL", "root", "SUB", "VISam", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e ACA, LGd and PL brain areas). This is the first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include =FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo= FALSE, include = FALSE}
session_12 <- get_session_data(12)
head(session_12)
```


```{r, echo = FALSE}
ggplot(session_12, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_12 <- get_session_data(12)
head(session_12)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_12)) {
  session_12$stimuli_condition <- factor(paste(session_12$contrast_left, session_12$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_12, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_12 <- get_session_data(12)
head(session_12)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_12 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 340 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 

# Session 14 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session14 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session14.rds")
names(session14)
```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 268 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo= FALSE}
session[[14]]$mouse_name

summary(session[[14]]$brain_area)
table(session[[14]]$brain_area)

summary(session[[14]]$contrast_left)
table(session[[14]]$contrast_left)
length(session[[14]]$contrast_left)

summary(session[[14]]$contrast_right)
table(session[[14]]$contrast_right)
length(session[[14]]$contrast_right)

summary(session[[14]]$feedback_type)
table(session[[14]]$feedback_type)
length(session[[14]]$feedback_type)

```
This session also evaluates mouse Lederberg's behavior and subsequent neural activity. There are 756 neurons found in 10 brain areas: CA1 (99 neurons), MOs (186 neurons), MRN (72 neurons), ORB (170 neurons), PAG (14 neurons), root (3 neurons), RSP (85 neurons), SCm (48 neurons, SCs (37 neurons), VISp (42 neurons). There are 268 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 82 trials resulted in a failure and 186 trials resulted in a success out of a total of 268 trials. Another way to look at that success-failure outcome is as follows: 30.6% of the the trials resulted in a failure; 69.4% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg, we can say that Lederberg's performance has experienced a dip in performance. Despite having a higher success rate in comparison to the other mice, this is quite the reversion of performance and ability in responding based on visual stimuli. With these findings, we must also explore Lederberg's performance over the 268 trials and see if there were any gradual improvements over time within just this session. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 268 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 130 times, 0.25 was chosen 38 times, 0.5 was chosen 41 times, and 1 was chosen 59 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 0.25, which is also on the lower end and was the same as the median of choosing a contrast left value. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Lederberg was equally inclined to choosing a lower contrast left and right value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 128 times, 0.25 was chosen 44 times, 0.5 was chosen 50 times, and 1 was chosen 46 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the right side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.





# Data Analysis

```{r, echo = FALSE}
n.session=14

i = 14

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss14_trial_data <- data.frame(
  trial_id = 1:268
)

trial_outcome_vector <- as.vector(session[[14]]$feedback_type[, 1])

ss14_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss14_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 14. From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench); and sessions 12-13 (Mouse: Lederberg), we know that Lederberg's success rate is already pretty high and improves from his previous session. There are a lot more successive successes in the middle of the session but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=14 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo= FALSE, include = FALSE} 
# Wrapping up the function:

i.s = 14

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(14,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are on par with the ones we have seen in Cori and Hench's previous sessions, but a lot higher Forssmann's sessions. 

The average spike counts in the VISp brain area is relatively stable with a common stabilization at the end shared with other brain areas. The MRN and SCm brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo= FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=13 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 14

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(14,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA1_avg_spk = CA1, 
    MOs_avg_spk = MOs, 
    MRN_avg_spk = MRN, 
    ORB_avg_spk = ORB,
    PAG_avg_spk = PAG, 
    root_avg_spk = root, 
    RSP_avg_spk = RSP, 
    SCm_avg_spk = SCm, 
    SCs_avg_spk = SCs, 
    VISp_avg_spk = VISp
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the CA1 and MRN panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the SCm and root brain areas experience stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 14

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the RSP brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. Additionally, however, there is a negative correlation between spike counts and feedback in some areas such as the VISp brain area. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE}
# Find the average number of spikes across neurons in each area

i.s=14 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 14

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(14,this_session = session[[i.s]])

```

```{r, echo=FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 14

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 14

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 14

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 14 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the SCm and MRN brain areas generally have higher average spikes and this is seen throughout trials 1-268; whereas the RSP brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the RSP brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the MOs and the CA1 brain areas have mirroring patterns in average spike counts, over the course of session 14, whereas some brain areas experience a sudden decline or increase in average spike counts such as the SCs and PAG brain areas. 

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 14

# Loop through each trial
for (i.t in 1:268) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 14

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 14

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 10 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the brain areas in this session, in relation to feedback. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to positive feedback.


```{r, echo = FALSE, include = FALSE}
i.s = 14

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "MOs", "MRN", "ORB", "PAG", "root", "RSP", "SCm", "SCs", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the PAG and SCs brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the PAG and root regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA1", "MOs", "MRN", "ORB", "PAG", "root", "RSP", "SCm", "SCs", "VISp"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e PAG, SCs and VISp brain areas). This is another first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_14 <- get_session_data(14)
head(session_14)
```


```{r, echo = FALSE}
ggplot(session_14, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_14 <- get_session_data(14)
head(session_14)
```

```{r, echo =FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_14)) {
  session_14$stimuli_condition <- factor(paste(session_14$contrast_left, session_14$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_14, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_14 <- get_session_data(14)
head(session_14)
```

```{r, include = FALSE, echo = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_14 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 268 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 

# Session 15 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session15 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session15.rds")
names(session15)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 404 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and *the date of which the trials occur.*

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[15]]$mouse_name

summary(session[[15]]$brain_area)
table(session[[15]]$brain_area)

summary(session[[15]]$contrast_left)
table(session[[15]]$contrast_left)
length(session[[15]]$contrast_left)

summary(session[[15]]$contrast_right)
table(session[[15]]$contrast_right)
length(session[[15]]$contrast_right)

summary(session[[15]]$feedback_type)
table(session[[15]]$feedback_type)
length(session[[15]]$feedback_type)

```
This session also evaluates mouse Lederberg's behavior and subsequent neural activity. There are 743 neurons found in 8 brain areas: BLA (132 neurons), CA3 (3 neurons), GPe (142 neurons), LGd (121 neurons), MB (45 neurons), root (83 neurons), VPM (162 neurons), ZI (55 neurons). There are 404 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 95 trials resulted in a failure and 309 trials resulted in a success out of a total of 404 trials. Another way to look at that success-failure outcome is as follows: 23.52% of the the trials resulted in a failure; 76.49% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg, we can say that Lederberg's performance has improved from his last session to the next. With these explorations, we must also explore Lederberg's performance over the 404 trials and see if there were any gradual improvements over time within just this session. This is most certainly will be an interesting session to explore due to the high success rate, once again.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 404 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 191 times, 0.25 was chosen 156 times, 0.5 was chosen 68 times, and 1 was chosen 89 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Lederberg was more inclined to choosing a lower contrast right than left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 189 times, 0.25 was chosen 67 times, 0.5 was chosen 59 times, and 1 was chosen 89 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen equally as frequent. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.




# Data Analysis

```{r, echo = FALSE}
n.session=15

i = 15

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss15_trial_data <- data.frame(
  trial_id = 1:404
)

trial_outcome_vector <- as.vector(session[[15]]$feedback_type[, 1])

ss15_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss15_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 15 From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench); and sessions 12-14 (Mouse: Lederberg), we know that Lederberg's success rate is already pretty high and improves from his previous session. There are a lot more successive successes in the middle of the session but some successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=15 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE, include = FALSE} 
# Wrapping up the function:

i.s = 15

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(15,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE, include = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are on par with the ones we have seen in Cori and Hench's previous sessions, but a lot higher Forssmann's sessions. 

The average spike counts in the LGd brain area is relatively stable with a common stabilization at the end shared with other brain areas. The CA3 and ZI brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=15 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 15

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(15,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    BLA_avg_spk = BLA,
    CA3_avg_spk = CA3, 
    GPe_avg_spk = GPe, 
    LGd_avg_spk = LGd, 
    MB_avg_spk = MB,
    root_avg_spk = root, 
    VPM_avg_spk = VPM, 
    ZI_avg_spk = ZI
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the GPe and root panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the CA3 brain area experiences stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 15

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the VPM brain area, we can see that it has a decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=15 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 15

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(15,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 15

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 15

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 15

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 15 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the CA3 brain area generally has higher average spikes and this is seen throughout trials 1-404; whereas the GPe brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the GPe brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the VPM and the LGd brain areas have mirroring patterns in average spike counts, over the course of session 15.

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 15

# Loop through each trial
for (i.t in 1:404) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 15

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 15

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 8 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the brain areas in this session, in relation to feedback. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to both positive and negative feedback.


```{r, echo = FALSE, include = FALSE}
i.s = 15

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("BLA", "CA3", "GPe", "LGd", "MB", "root", "VPM", "ZI"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the CA3 and GPe brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the CA3 and root regions, where the average spike count for positive feedback has outliers.

```{r, echo= FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("BLA", "CA3", "GPe", "LGd", "MB", "root", "VPM", "ZI"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e CA3, ZI and root brain areas). This is another first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo=FALSE}
session_15 <- get_session_data(15)
head(session_15)
```


```{r, echo = FALSE}
ggplot(session_15, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo=FALSE, include =FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include =FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include=FALSE, echo =FALSE}
session_15 <- get_session_data(15)
head(session_15)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_15)) {
  session_15$stimuli_condition <- factor(paste(session_15$contrast_left, session_15$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_15, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_15 <- get_session_data(15)
head(session_15)
```

```{r, echo = FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_15 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 404 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 

# Session 16 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session16 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session16.rds")
names(session16)
```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 280 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment.

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r,echo = FALSE}
session[[16]]$mouse_name

summary(session[[16]]$brain_area)
table(session[[16]]$brain_area)

summary(session[[16]]$contrast_left)
table(session[[16]]$contrast_left)
length(session[[16]]$contrast_left)

summary(session[[16]]$contrast_right)
table(session[[16]]$contrast_right)
length(session[[16]]$contrast_right)

summary(session[[16]]$feedback_type)
table(session[[16]]$feedback_type)
length(session[[16]]$feedback_type)

```
This session also evaluates mouse Lederberg's behavior and subsequent neural activity. There are 474 neurons found in 6 brain areas: CA3 (21 neurons), LGd (73 neurons), MB (77 neurons), SSp (24 neurons), SSs (120 neurons), TH (159 neurons). There are 280 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 79 trials resulted in a failure and 201 trials resulted in a success out of a total of 280 trials. Another way to look at that success-failure outcome is as follows: 28.21% of the the trials resulted in a failure; 71.79% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg, we can say that Lederberg's performance did not improve from his last session despite the high success rate. With these explorations, we must also explore Lederberg's performance over the 280 trials and see if there were any gradual improvements over time within just this session. This is most certainly will be an interesting session to explore due to the high success rate, once again.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 280 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 124 times, 0.25 was chosen 42 times, 0.5 was chosen 43 times, and 1 was chosen 71 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Lederberg was more inclined to choosing a lower contrast right than left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 127 times, 0.25 was chosen 64 times, 0.5 was chosen 38 times, and 1 was chosen 51 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.




# Data Analysis

```{r, echo = FALSE}
n.session=16

i = 16

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss16_trial_data <- data.frame(
  trial_id = 1:280
)

trial_outcome_vector <- as.vector(session[[16]]$feedback_type[, 1])

ss16_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss16_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 16 From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench); and sessions 12-15 (Mouse: Lederberg), we know that Lederberg's success rate is already pretty high and improves from his previous session. There are a lot more successive successes in the middle of the session but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=16 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE, include = FALSE} 
# Wrapping up the function:

i.s = 16

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(16,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in Cori and Hench's previous sessions, but on par with Forssmann's sessions. 

The average spike counts in the SSs brain area is relatively stable with a common stabilization at the end shared with other brain areas. The CA3 and SSs brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=16 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 16

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(16,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    CA3_avg_spk = CA3, 
    LGd_avg_spk = LGd, 
    MB_avg_spk = MB, 
    SSp_avg_spk = SSp,
    SSs_avg_spk = SSs, 
    TH_avg_spk = TH
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)
print(trial.long)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the SSp and TH panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the LGd brain area experiences stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 16

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the LGd brain area, we can see that it has a slightly decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=16 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 16

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(16,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 16

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 16

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 16

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 16 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LGd brain area generally has higher average spikes and this is seen throughout trials 1-280; whereas the SSs brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the SSs brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the MB and the CA3 brain areas have mirroring patterns in average spike counts, over the course of session 16, whereas SSp experiences a decrease in average spike counts at around the 80th trial mark.

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 16

# Loop through each trial
for (i.t in 1:280) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 16

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 16

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 6 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the brain areas in this session, in relation to feedback. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to both positive and negative feedback.


```{r, echo = FALSE, include = FALSE}
i.s = 16

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("CA3", "LGd", "MB", "SSp", "SSs", "TH"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the CA3 and SSs brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the MB and SSp regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("CA3", "LGd", "MB", "SSp", "SSs", "TH"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e SSs, MB and TH brain areas). This is another first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_16 <- get_session_data(16)
head(session_16)
```


```{r, echo = FALSE}
ggplot(session_16, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_16 <- get_session_data(16)
head(session_16)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_16)) {
  session_16$stimuli_condition <- factor(paste(session_16$contrast_left, session_16$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_16, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo=FALSE}
session_16 <- get_session_data(16)
head(session_16)
```

```{r, echo  = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_16 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo=FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 280 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 

# Session 17 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session17 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session17.rds")
names(session17)
```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 224 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[17]]$mouse_name

summary(session[[17]]$brain_area)
table(session[[17]]$brain_area)

summary(session[[17]]$contrast_left)
table(session[[17]]$contrast_left)
length(session[[17]]$contrast_left)

summary(session[[17]]$contrast_right)
table(session[[17]]$contrast_right)
length(session[[17]]$contrast_right)

summary(session[[17]]$feedback_type)
table(session[[17]]$feedback_type)
length(session[[17]]$feedback_type)

```
This session also evaluates mouse Lederberg's behavior and subsequent neural activity. There are 565 neurons found in 6 brain areas: LD (12 neurons), MEA (41 neurons), root (358 neurons), RT (44 neurons), VPL (50 neurons), VPM (60 neurons). There are 224 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 38 trials resulted in a failure and 186 trials resulted in a success out of a total of 224 trials. Another way to look at that success-failure outcome is as follows: 16.96% of the the trials resulted in a failure; 83.04% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg, we can say that Lederberg's performance has improved from his first session to the next by 15.67%. Additionally, Lederberg's success rate was higher than any of Cori, Forssmann, and Hench's sessions. With these explorations, we must also explore Lederberg's performance over the 224 trials and see if there were any gradual improvements over time within just this session. This is most certainly will be an interesting session to explore due to the high success rate.

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 224 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 103 times, 0.25 was chosen 41 times, 0.5 was chosen 35 times, and 1 was chosen 45 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Lederberg was more inclined to choosing a lower contrast right than left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 90 times, 0.25 was chosen 39 times, 0.5 was chosen 36 times, and 1 was chosen 59 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the left side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the right side, and 1 was chosen more frequently on the right side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.





# Data Analysis

```{r, echo = FALSE}
n.session=17

i = 17

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss17_trial_data <- data.frame(
  trial_id = 1:224
)

trial_outcome_vector <- as.vector(session[[17]]$feedback_type[, 1])

ss17_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss17_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 17 From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench); and sessions 12-16 (Mouse: Lederberg), we know that Lederberg's success rate is already pretty high and improves from his previous session. There are a lot more successive successes in the middle of the session but also a lot of successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=17 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, include = FALSE, echo = FALSE} 
# Wrapping up the function:

i.s = 17

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(17,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in Cori and Hench's previous sessions, but on par with Forssmann's sessions. 

The average spike counts in the root brain area is relatively stable with a common stabilization at the end shared with other brain areas. The LD and VPL brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo = FALSE, include  = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=17 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 17

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(17,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    LD_avg_spk = LD, 
    MEA_avg_spk = MEA, 
    root_avg_spk = root, 
    RT_avg_spk = RT,
    VPL_avg_spk = VPL, 
    VPM_avg_spk = VPM
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the root and RT panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the VPL brain area experiences stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 17

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the root brain area, we can see that it has a slightly decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. Additionally, however, the LD, MEA, and VPL brain areas have negative correlation which do not align with our beliefs. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=17 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 17

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(17,this_session = session[[i.s]])

```

```{r, include = FALSE, echo = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 17

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 17

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 17

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 17 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the LD brain area generally has higher average spikes and this is seen throughout trials 1-224; whereas the root brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the root brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the VPM and the RT brain areas have mirroring patterns in average spike counts, over the course of session 17.

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 17

# Loop through each trial
for (i.t in 1:224) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, include = FALSE, echo= FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 17

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 17

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 6 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the brain areas in this session, in relation to feedback. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to both positive and negative feedback.


```{r, echo = FALSE, include = FALSE}
i.s = 17

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("LD", "MEA", "root", "RT", "VPL", "VPM"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the RT and VPL brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the LD and RT regions, where the average spike count for positive feedback has outliers.

```{r, echo=FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("LD", "MEA", "root", "RT", "VPL", "VPM"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e LD, RT and VPL brain areas). This is another first session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo =FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include=FALSE, echo=FALSE}
session_17 <- get_session_data(17)
head(session_17)
```


```{r, echo=FALSE}
ggplot(session_17, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE ,include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_17 <- get_session_data(17)
head(session_17)
```

```{r, include = FALSE, echo = FALSE}
if (!"stimuli_condition" %in% names(session_17)) {
  session_17$stimuli_condition <- factor(paste(session_17$contrast_left, session_17$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_17, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to an increase in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in increasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_17 <- get_session_data(17)
head(session_17)
```

```{r, include = FALSE, echo = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_17 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 224 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 

# Session 18 Base Evaluation (Mouse: Lederberg)
```{r, echo = FALSE}
session18 = readRDS("C:/Users/19162/Desktop/STA141A Project/Data/sessions/session18.rds")
names(session18)

```
From this chunk of code, we can look at the very, very basic structure of this session. We can see that there are 216 trials, with information regarding contrast left values, contrast right values, the success/failure in the decisions of the mouse (in other words, the feedback type), the mouse's name, the brain areas where of which the neurons live, the number of brain areas, the number of neurons, the numbers of spikes of neurons in the visual cortex in time bins which are defined in `time`, the time which are the centers of the time bins for `spks`, and the date of the experiment. 

```{r, echo = FALSE, include = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE}
session[[18]]$mouse_name

summary(session[[18]]$brain_area)
table(session[[18]]$brain_area)

summary(session[[18]]$contrast_left)
table(session[[18]]$contrast_left)
length(session[[18]]$contrast_left)

summary(session[[18]]$contrast_right)
table(session[[18]]$contrast_right)
length(session[[18]]$contrast_right)

summary(session[[18]]$feedback_type)
table(session[[18]]$feedback_type)
length(session[[18]]$feedback_type)

```
This session also evaluates mouse Lederberg's behavior and subsequent neural activity. There are 1090 neurons found in 10 brain areas: ACB (155 neurons), CA3 (35 neurons), CP (158 neurons), LGd (89 neurons), OT (26 neurons), root (99 neurons), SI (48 neurons), SNr (130 neurons), TH (175 neurons), ZI (175 neurons). There are 216 trials and each trial has a possible feedback of 1 (for success) and -1 (for failure). In this session, 42 trials resulted in a failure and 174 trials resulted in a success out of a total of 216 trials. Another way to look at that success-failure outcome is as follows: 19.44% of the the trials resulted in a failure; 80.55% of the trials resulted in a success. So far, just be looking at the success/failure rate for mouse Lederberg, we can say that Lederberg's performance rather worsened from his previous session to the next, but not by a wide margin.With these explorations, we must also explore Lederberg's performance over the 216 trials and see if there were any gradual improvements over time within just this session. This is most certainly will be an interesting session to explore due to the high success rate. What I have noticed about Lederberg is that he demonstrates bits of success then followed by reversions in his improvement. This is certainly something I will need to explore within trials. 

We can also look at the summary statistics of how the strength of a left and right contrast stimuli occurred as well as the frequency. 

In the 216 trials,  the smallest value of a contrast stimuli on the left side was a 0 and the greatest value of a contrast stimuli on the left side was a 1. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the left side: 0 was chosen 103 times, 0.25 was chosen 36 times, 0.5 was chosen 34 times, and 1 was chosen 43 times.  One interesting discovery here is that the median of choosing a contrast left value was 0.25, which is on the quite low. We will need to take a deeper look into what this may mean and its implications for its success rate. 

The smallest value of a contrast stimuli on the right side was a 0 and the greatest value of a contrast stimuli on the right side was a 1. One interesting discovery here is that the median of choosing a contrast right value was 1, which is high. Without knowing both contrast levels and feedback of each trials so far, we can naively mention that mouse Lederberg was equally inclined to choosing a lower contrast right value and left value. Here are the frequency statistics that indicate how often Hench chose a specific contrast level on the right side: 0 was chosen 110 times, 0.25 was chosen 32 times, 0.5 was chosen 33 times, and 1 was chosen 41 times.

From the evaluation of these summary and frequency statistics, we can say that 0 was chosen more frequently on the right side, 0.25 was chosen more frequently on the left side, 0.5 was chosen more frequently on the left side, and 1 was chosen more frequently on the left side. However, though these frequency statistics provide valuable information, what is most important is the success rate per trial and the subsequent analyses will provide just that along with the respective neural activities attached to the mouse's decision making process.





# Data Analysis

```{r, echo = FALSE}
n.session=18

i = 18

tmp = session[[i]]  

meta <- tibble(
  mouse_name = tmp$mouse_name,
  date_exp = tmp$date_exp,
  n_brain_area = length(unique(tmp$brain_area)),
  n_neurons = dim(tmp$spks[[1]])[1],
  n_trials = length(tmp$feedback_type),
  success_rate = mean(tmp$feedback_type + 1) / 2
)

print(meta)


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
ss18_trial_data <- data.frame(
  trial_id = 1:216
)

trial_outcome_vector <- as.vector(session[[18]]$feedback_type)


ss18_trial_data$trial_outcome <- trial_outcome_vector

# Plotting the updated data
library(ggplot2)

ggplot(ss18_trial_data, aes(x = trial_id, y = trial_outcome)) +
  geom_line() +
  geom_point() +
  labs(x = "Trial", y = "Success = 1 or Failure = 0", 
       title = "Success Rate per each Trial", )
  theme_minimal()


```
This plot shows us the trend of successes and failures over the trials in session 18 From our base evaluation from sessions 1-3 (Mouse: Cori); sessions 4-7 (Mouse: Forssmann); and sessions 8-11 (Mouse: Hench); and sessions 12-17 (Mouse: Lederberg), we know that Lederberg's success rate is already pretty high and improves from his previous session. There are a lot more successive successes in the middle of the session but also a few successive failures at the end. In almost all of the sessions so far, the trials at the end almost always end up with negative feedback. It will be imperative to understand and visualize the neural activity at these times and the respective brain regions responsible for such results.


```{r, echo = FALSE, include = FALSE}

i.s=18 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))
```

```{r, echo = FALSE, include = FALSE} 
# Wrapping up the function:

i.s = 18

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(18,this_session = session[[i.s]])


n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))
# Alternatively, you can extract these information in the meta that we created before.

# We will create a data frame that contain the average spike counts for each area, feedback type,  the two contrasts, and the trial id

trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
 
```

```{r, echo = FALSE}
area.col=rainbow(n=n.area,alpha=0.7)
# In base R, I usually initiate a blank plot before drawing anything on it
plot(x=1,y=0, col='white',xlim = c(-10, n.trial + 10), ylim = c(min(trial.summary[,1:n.area]) * 0.9, max(trial.summary[,1:n.area]) * 1.1), xlab = "Trials", ylab = "Average spike counts", main = paste("Spikes per area in Session", i.s))

for(i in 1:n.area){
  lines(y=trial.summary[[i]],x=trial.summary$id,col=area.col[i],lty=2,lwd=1)
  lines(smooth.spline(trial.summary$id, trial.summary[[i]]),col=area.col[i],lwd=3)
  }
legend("topright", 
  legend = colnames(trial.summary)[1:n.area], 
  col = area.col, 
  lty = 1, 
  cex = 0.8
)

```
At first glance, we can see that a lot of the average spike counts in some brain areas are a lot lower than the ones we have seen in Cori and Hench's previous sessions, but on par with Forssmann's sessions. 

The average spike counts in the LGd brain area is relatively stable with a common stabilization at the end shared with other brain areas. The CA3 and TH brain region experiences the most fluctuations in its relative lines, while the rest of the brain areas are the only regions with a stable average spike count. Due to the occasional sudden spikes and the relative decreasing nature of the average spike counts over the course of this session, it is imperative to understand what this means in relation to the success rate. This session arguably has the most stable average spike count among all sessions.

```{r, echo = FALSE, include = FALSE}

n.session=length(session)

# in library tidyverse
meta <- tibble(
  mouse_name = rep('name',n.session),
  date_exp =rep('dt',n.session),
  n_brain_area = rep(0,n.session),
  n_neurons = rep(0,n.session),
  n_trials = rep(0,n.session),
  success_rate = rep(0,n.session)
)


for(i in 1:n.session){
  tmp = session[[i]];
  meta[i,1]=tmp$mouse_name;
  meta[i,2]=tmp$date_exp;
  meta[i,3]=length(unique(tmp$brain_area));
  meta[i,4]=dim(tmp$spks[[1]])[1];
  meta[i,5]=length(tmp$feedback_type);
  meta[i,6]=mean(tmp$feedback_type+1)/2;
  }

i.s=18 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

# for(i in 1:dim(spk.trial)[1]){
#  spk.count[i]=sum(spk.trial[i,])
# }

# Next we take the average of spikes across neurons that live in the same area 

# You can use tapply() or group_by() in dplyr

# tapply():
spk.average.tapply=tapply(spk.count, area, mean)


# dplyr: 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 18

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(18,this_session = session[[i.s]]) 




n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)

```

```{r, echo = FALSE}
library(tidyverse)

trial.summary <- trial.summary %>%
  rename(
    ACB_avg_spk = ACB, 
    CA3_avg_spk = CA3, 
    CP_avg_spk = CP, 
    LGd_avg_spk = LGd,
    OT_avg_spk = OT, 
    root_avg_spk = root,
    SI_avg_spk = SI, 
    SNr_avg_spk = SNr,
    TH_avg_spk = TH,
    ZI_avg_spk = ZI
  )

# Reshape the data frame from wide to long format correctly
trial.long <- pivot_longer(
  trial.summary, 
  cols = ends_with("avg_spk"),  # Selects columns that end with "avg_spk"
  names_to = "brain_area",      # Specifies the new column name for the brain areas
  values_to = "spike_count",    # Specifies the new column name for the spike counts
  names_pattern = "(.*)_"       # Extracts the brain area name by removing the trailing underscore and "avg_spk"
)

ggplot(trial.long, aes(x = id, y = spike_count)) + 
  geom_line() + 
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  facet_wrap(~ brain_area, scales = 'free_y') +
  labs(x = "Trial ID", y = "Spike Count", title = "Spike Counts Across Brain Areas by Trial") +
  theme_minimal()


```
This plot allows us to take a deeper look into each brain area across the trials and helps us understand the average spike counts better. From the root and SNr panels, we can see that these brain regions experience a  decline in its average spike counts, whereas the SI brain area experiences stability in its average spike count over the course of the session.  What we have already seen that is that Lederberg's success rate is already pretty high and this makes us wonder if the relatively increasing fluctuations and somewhat increasing average spike counts could predict or even correlate with a success in the decision making process (and vise versa). We will explore this next. 


```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)

i.s = 18

# Assuming trial.long is the long-format data frame with brain_area, spike_count, and feedback columns
# First, make sure the feedback is numeric and has the correct values
trial.long$feedback <- as.numeric(trial.long$feedback)

# Calculate correlation for each brain area
correlations <- trial.long %>%
  group_by(brain_area) %>%
  summarize(correlation = cor(spike_count, feedback)) %>%
  ungroup()

# Create a correlation plot
ggplot(correlations, aes(x = reorder(brain_area, correlation), y = correlation)) +
  geom_col() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_flip() + # Flipping coordinates for easier readability
  theme_minimal() +
  labs(title = "Point-Biserial Correlation of Average Spike Count with Feedback",
       x = "Brain Area",
       y = "Correlation Coefficient")


```
With our assumption that an increasing or stable average spike count could lead to a success in decision-making, this plot confirms such assumptions to a certain degree. There is rather a very slight relationship between the two, however, all things considered, there are positive correlations between the two. Looking at the root brain area, we can see that it has a slightly decreasing average spike count over time and a positive correlation, indicating that a decreasing average spike count correlates with negative feedback. This can be extending to many brain area, including the ones with stable fluctuations in average spike counts. Additionally, however, the SI brain area has negative correlation which do not align with our beliefs. It is clear that these relationships depend on the brain area which would be difficult to generalize to all sessions. It is possible, however, that brain areas over all the sessions carry the same pattern. We will continue to explore this across sessions. 

```{r, echo = FALSE, include = FALSE}
# Find the average number of spikes across neurons in each area

i.s=18 # indicator for this session

i.t=1 # indicator for this trial 

spk.trial = session[[i.s]]$spks[[i.t]]
area=session[[i.s]]$brain_area

# We need to first calculate the number of spikes for each neuron during this trial 
spk.count=apply(spk.trial,1,sum)

for(i in 1:dim(spk.trial)[1]){
spk.count[i]=sum(spk.trial[i,])
}

# Next we take the average of spikes across neurons that live in the same area 
# To use dplyr you need to create a data frame
tmp <- data.frame(
  area = area,
  spikes = spk.count
)
# Calculate the average by group using dplyr
spk.average.dplyr =tmp %>%
  group_by(area) %>%
  summarize(mean= mean(spikes))

i.s = 18

average_spike_area<-function(i.t,this_session){
  spk.trial = this_session$spks[[i.t]]
  area= this_session$brain_area
  spk.count=apply(spk.trial,1,sum)
  spk.average.tapply=tapply(spk.count, area, mean)
  return(spk.average.tapply)
  }

# Test the function
average_spike_area(18,this_session = session[[i.s]])

```

```{r, echo = FALSE, include = FALSE}
#This chunk of code aggregates neural activity by trial

i.s = 18

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 18

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
print(trial.summary)
 
```

```{r, echo = FALSE}
library(ggplot2)
library(reshape2) # For melting the data frame

i.s = 18

# Assuming 'trial.summary' has columns for different brain areas and you want to melt it for heatmap
# First, ensure the data is in the correct format
trial.summary$id <- as.numeric(trial.summary$id) # Ensuring 'id' is numeric

# Melting the data frame for a heatmap
# 'id' is the identifier, everything else is considered a variable
heat_data <- melt(trial.summary, id.vars = 'id')

# Ensuring 'value' (which will be used as 'spike_count') is numeric
heat_data$value <- as.numeric(as.character(heat_data$value))

# Creating the heatmap
ggplot(heat_data, aes(x = id, y = variable, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient(low = "pink", high = "black") +
  labs(x = "Trial ID", y = "Brain Area", fill = "Average Spike Count") +
  theme_get()


```
This heat map looks at the variation of the average spike counts throughout the trials in session 18 per brain area. There are a couple of brain areas that stand out in this exploration. For example, the root brain area generally has higher average spikes and this is seen throughout trials 1-216; whereas the CP brain area has a lower average spike count over the course of the session.  These variations in average spike counts can be due to what these regions are responsible for in the decision making process. It is naively possible to conclude that the CP brain area has a lesser role in the memory retrieval, decision making, and/or execution processes. We can also see how the CP and the ACB brain areas have mirroring patterns in average spike counts, over the course of session 18.

--- 


```{r, echo = FALSE, include = FALSE}
# Initialize an empty data frame to hold the results
all_trials_df <- data.frame(
  trial_id = integer(),
  brain_area = character(),
  average_spikes = numeric()
)

i.s = 18

# Loop through each trial
for (i.t in 1:216) {
  avg_spikes <- average_spike_area(i.t, this_session = session[[i.s]])
  
  # Create a temporary data frame for this trial
  temp_df <- data.frame(
    trial_id = rep(i.t, length(avg_spikes)),
    brain_area = names(avg_spikes),
    average_spikes = unname(avg_spikes)
  )
  
  # Bind the temporary data frame to the main data frame
  all_trials_df <- rbind(all_trials_df, temp_df)
}

# Check the first few rows of the aggregated data frame
head(all_trials_df)
#print(all_trials_df)

```

```{r, include = FALSE, echo = FALSE}
#This chunk of code aggregates neural activity by trial

library(tidyverse)

i.s = 18

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                          session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

i.s = 18

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left_contr.','right_contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)
#print(trial.summary)
 
```


```{r, echo = FALSE}
library(tidyverse)

# Assuming 'trial.summary' is your data frame and it contains columns for each brain area representing average spikes per trial, along with 'feedback' and 'id' columns

# Reshape data from wide to long format
trial.long <- trial.summary %>%
  pivot_longer(
    cols = -c(id, feedback),  # Exclude 'id' and 'feedback' columns from the reshaping
    names_to = "brain_area",  # The column name for brain areas
    values_to = "avg_spikes"  # The column name for average spikes
  )

# Plotting
ggplot(trial.long, aes(x = id, y = avg_spikes, color = as.factor(feedback))) +
  geom_point() +  # Use points to represent average spikes
  facet_wrap(~brain_area, scales = 'free_y', nrow = 2) +  # Separate plot for each brain area with free y scales
  labs(title = "Average Spikes per Trial by Brain Area and Feedback",
       x = "Trial ID",
       y = "Average Spikes") +
  scale_color_manual(values = c("1" = "blue", "-1" = "red"), name = "Feedback Type", 
                     labels = c("1" = "Success", "-1" = "Failure")) +  # Customize colors for feedback types
  theme_minimal() +
  theme(legend.position = "bottom") +  # Position the legend at the bottom
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Tilt the x-axis labels



```




There are 10 plots (ignoring the left and right contrast panels) that provide an understanding of what is taking place in each of the brain areas in this session, in relation to feedback. What these plots intend to look at are the various neural activities that are taking place mouse as Lederberg makes a decision as to what contrast to choose. In all of these panels, Lederberg seems to either have sparse average spike count with regards to both positive and negative feedback.


```{r, echo = FALSE,include = FALSE}
i.s = 18

n.trial=length(session[[i.s]]$feedback_type)
n.area=length(unique(session[[i.s]]$brain_area ))

# Data frame that contains the average spike counts for each area, feedback type,  the two contrasts, and the trial id
trial.summary =matrix(nrow=n.trial,ncol= n.area+1+2+1)
for(i.t in 1:n.trial){
  trial.summary[i.t,]=c(average_spike_area(i.t,this_session = session[[i.s]]),
                        session[[i.s]]$feedback_type[i.t],
                        session[[i.s]]$contrast_left[i.t],
                        session[[i.s]]$contrast_right[i.s],
                        i.t)
}

colnames(trial.summary)=c(names(average_spike_area(i.t,this_session = session[[i.s]])), 'feedback', 'left contr.','right contr.','id' )

# Turning it into a data frame
trial.summary <- as_tibble(trial.summary)
head(trial.summary)

```


```{r, echo = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Assuming 'trial.summary' is your original data frame
longer_data <- trial.summary %>%
  pivot_longer(cols = c("ACB", "CA3", "CP", "LGd", "OT", "root", "SI", "SNr", "TH", "ZI"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

# Now plotting the reshaped data
ggplot(longer_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_jitter(width = 0.2) + 
  facet_wrap(~`Brain Area`, scale = "free_y") +  # Using 'scales = "free_y"' to adjust y-axis for each plot
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))


```
This plot allows us to take an inside look at the neural activity per outcome. Across the brain areas, it can be seen that negative feedback leads to a tighter spread of the average spike counts with some outliers; whereas positive feedback leads to more spread of the average spike counts with fewer outliers. For example, negative feedback in the OT and root brain areas point to some outliers. This can lead to the possible generalization that making the right decision demonstrates a more stable and spread out average spike count, whereas the wrong decision leads to the occasional high or low average spike count. This is a continual finding from the previous sessions. There are some exceptions in the ACB and SI regions, where the average spike count for positive feedback has outliers.

```{r, echo = FALSE}
long_data <- trial.summary %>%
  pivot_longer(cols = c("ACB", "CA3", "CP", "LGd", "OT", "root", "SI", "SNr", "TH", "ZI"), 
               names_to = "Brain Area", 
               values_to = "Spike Count")

ggplot(long_data, aes(x = factor(feedback), y = `Spike Count`)) +
  geom_boxplot() +
  facet_wrap(~`Brain Area`) +
  labs(x = "Feedback", y = "Spike Count", title = "Spike Counts by Feedback Across Brain Areas") +
  scale_x_discrete(labels = c("-1" = "Negative Feedback", "1" = "Positive Feedback"))

```
Additionally, we can take a look at these box plots and affirm our findings from above. There are more outliers and skewness of average spike counts in the brain areas with negative feedback - though positive feedback also has a lot of outliers as well (i.e ACB, CP and SI brain areas). This is another session where positive feedback had more outliers than negative feedback. This could be due to the fact that Lederberg's success rate is already high contributing to more un-normal behavior related to positive feedback. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_18 <- get_session_data(18)
head(session_18)
```


```{r, echo= FALSE}
ggplot(session_18, aes(x = trail_id, y = region_mean_spike)) +
  geom_line() +
  facet_wrap(~feedback_type)

```
Here is another visualization that gives a better picture of average spikes in both feedback types. It can be seen that positive feedback is more spread out while negative feedback is more tightly clustered in length but has major upward and downward spikes that is uncharacteristic to its normal patterns.


Now, we would like to evaluate neural activity overtime with respect to stimuli conditions and feedback:
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE ,include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_18 <- get_session_data(18)
head(session_18)
```

```{r, echo = FALSE, include = FALSE}
if (!"stimuli_condition" %in% names(session_18)) {
  session_18$stimuli_condition <- factor(paste(session_18$contrast_left, session_18$contrast_right, sep = " | "))
}


```


```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming session_1 has been properly mutated to include stimuli_condition
ggplot(session_18, aes(x = trail_id, y = region_mean_spike)) +
  geom_line(aes(color = as.factor(feedback_type))) + # Line plot to show trends over time
  geom_point(aes(color = as.factor(feedback_type))) + # Add points to highlight individual trials
  facet_wrap(~stimuli_condition, scales = "free_x", ncol = 4) + # Facet by stimuli condition
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + # Rotate and adjust size of x-axis labels
  labs(title = "Neural Activity Over Time by Stimulus Condition and Feedback",
       x = "Trail ID",
       y = "Region Mean Spike",
       color = "Feedback")


```
Before we get into the significance of this plot and what it contributes to our overall story, it is important to detail what each component of this plot represents. Each point represents the mean neural spike count for a single trial at a given stimulus condition; the color of the points indicates the type of feedback received - green points show trials where the feedback was successful (1), and red points indicate trials where the feedback was a failure (-1); each panel also provides the possible values for a left-contrast value and a right-contrast value and each possible combination, and the corresponding choice and subsequent feedback. With that, we can begin our commentary on these panels. 

We can see that some plots demonstrate a particular trend. When Hench was faced with 0.25-0.25, one success/failure after another led to a decrease in average spike counts. This can also be seen in the cases 0.5-0.5 and 1-1. What we can conclude from this plot is that by comparing across different panels (stimulus conditions), we can see that some successes and failures tend to result in decreasing neural activity on average despite great fluctuations. These are definitely weak conclusions that must be explored over all of the sessions to make generalizations. All in all, this plot allows us to compare the effects of each type of stimulus on neuronal activity.


```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_18 <- get_session_data(18)
head(session_18)
```

```{r, echo= FALSE, include = FALSE}
# Calculate the running average for region_mean_spike
average_spike <- session_18 %>%
  arrange(trail_id) %>%  # Make sure the data is ordered by trail_id
  mutate(cumulative_mean_spike = cummean(region_mean_spike))

```

```{r, echo = FALSE}
library(ggplot2)
library(dplyr)

# Assuming 'average_spike' is your detailed data and 'running_avg' is your running average data.
# First, we need to make sure that both datasets have the same structure and corresponding variables.
average_spike <- average_spike %>%
  arrange(trail_id) %>%
  mutate(cumulative_mean_spike = cummean(region_mean_spike)) # Calculate the running average

# Create the base plot with the detailed data
base_plot <- ggplot(average_spike, aes(x = trail_id)) +
  geom_point(aes(y = region_mean_spike, color = as.factor(feedback_type))) + # Add points with color representing feedback type
  scale_color_manual(values = c("1" = "green", "-1" = "red"), 
                     name = "Feedback",
                     labels = c("Failure", "Success")) +
  theme_minimal() +
  labs(title = "Neural Activity and Average Spike Counts Over Trials",
       x = "Trail ID",
       y = "Region Mean Spike")

# Add the running average line to the plot
combined_plot <- base_plot +
  geom_line(data = average_spike, aes(y = cumulative_mean_spike))

# Print the combined plot
print(combined_plot)


```
This plot further demonstrates the times of which these successes and failures took place and its relationship with respect to the average spike counts. It can be seen that successes tend to be more spread out throughout the 216 trials but also has greater variation in its average spike counts, whereas failures happen in clusters. It is interesting to see that Lederberg ends this session with many failures which is also the case for Cori, Forssmann, and Hench, but has a lot of successes clustered in between the failures. 


# Comprehensive EDA (among sessions and mice)

```{r, include = FALSE, echo = FALSE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, include = FALSE, echo = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r, include = FALSE, echo = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)

```

```{r, include = FALSE, echo = FALSE}
binename <- paste0("bin", as.character(1:40))

get_trail_functional_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  trail_bin_average <- matrix(colMeans(spikes), nrow = 1)
  colnames(trail_bin_average) <- binename
  trail_tibble  = as_tibble(trail_bin_average)%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  
  trail_tibble
}
get_session_functional_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_functional_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- as_tibble(do.call(rbind, trail_list))
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, include = FALSE, echo = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_functional_data(session_id)
}
full_functional_tibble <- as_tibble(do.call(rbind, session_list))
full_functional_tibble$session_id <- as.factor(full_functional_tibble$session_id )
full_functional_tibble$contrast_diff <- abs(full_functional_tibble$contrast_left-full_functional_tibble$contrast_right)

full_functional_tibble$success <- full_functional_tibble$feedback_type == 1
full_functional_tibble$success <- as.numeric(full_functional_tibble$success)
```


```{r,echo=FALSE, include = FALSE}
head(full_functional_tibble)
```

### Estimate success rate over different groups (session and mouse) 
```{r, echo = FALSE}
full_functional_tibble %>% group_by(session_id) %>% summarize(success_rate = mean(success, na.rm = TRUE))
summary(full_functional_tibble)
```

### What is the average spike rate over each session 
```{r, echo=FALSE}
average_spike <-full_tibble %>% group_by( session_id, trail_id) %>% mutate(mean_spike = sum(region_sum_spike)/sum(region_count))
average_spike %>% group_by(session_id) %>% summarise(mean_session_spike = mean(mean_spike))
```
We have already found that decreasing average spike counts over a session correlate with negative feedback in most brain areas and in most sessions, but to generalize this across all sessions, we will look into that at all sessions next. 

```{r, echo = FALSE}
library(dplyr)
library(ggplot2)

# Calculate success_rate for each session_id
success_rate_by_session <- full_functional_tibble %>%
  mutate(session_id = as.character(session_id)) %>%
  group_by(session_id) %>%
  summarize(success_rate = mean(success, na.rm = TRUE), .groups = 'drop')

# Calculate average_spike_rate for each session_id
average_spike_rate_by_session <- full_tibble %>%
  mutate(session_id = as.character(session_id)) %>%
  group_by(session_id, trail_id) %>%
  summarize(mean_spike = sum(region_sum_spike) / sum(region_count), .groups = 'drop') %>%
  group_by(session_id) %>%
  summarize(average_spike_rate = mean(mean_spike), .groups = 'drop')

# Combine success_rate and average_spike_rate into a single dataframe
combined_metrics <- success_rate_by_session %>%
  inner_join(average_spike_rate_by_session, by = "session_id")

# Create the correlation plot
ggplot(combined_metrics, aes(x = success_rate, y = average_spike_rate)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue") +
  theme_minimal() +
  labs(title = "Correlation between Success Rate and Average Spike Rate",
       x = "Success Rate",
       y = "Average Spike Rate")

# Assuming combined_metrics contains the columns success_rate and average_spike_rate
correlation_coefficient <- cor(combined_metrics$success_rate, combined_metrics$average_spike_rate, use = "complete.obs")

# Print the correlation coefficient
print(correlation_coefficient)


```

In this plot, the regression line appears to be relatively flat, suggesting that there might be a weak or no significant correlation between success rate and average spike rate across all sessions. Additionally, the data points appear to be widely spread out vertically at each level of success rate, which suggests high variability in the average spike rates that isn't well explained by the success rate alone. Furthermore, with the correlation coefficient being very small, the relationship is very weak. However, since it is a positive coefficient, the relationship between decreasing average spike counts and negative feedback was just as we thought. But, overall and for these reasons, a relationship between success rate and average spike counts is limited to each individual session and mouse. 

## What is different among each trail?
### What is the contrast difference distribution?
```{r,echo=FALSE, include = FALSE}
full_functional_tibble %>% group_by(contrast_diff) %>% count() %>% 
  ungroup() %>% 
  mutate(perc = `n` / sum(`n`)) %>% 
  arrange(perc) %>%
  mutate(labels = scales::percent(perc))
```

### How does the contrast difference affect the success rate?
```{r,echo=FALSE}
full_functional_tibble %>% group_by(contrast_diff) %>% summarize(success_rate = mean(success, na.rm = TRUE))
```
One thing that is clear here is that the greater the contrast difference, the higher chance of success. We will explore this further. 

```{r, echo = FALSE}
library(tidyverse)

# Calculate the success_rate by contrast_diff
success_rate_by_contrast <- full_functional_tibble %>%
  group_by(contrast_diff) %>%
  summarize(success_rate = mean(success, na.rm = TRUE), .groups = 'drop')

# Scatter plot with a smoothed line to see the correlation
ggplot(success_rate_by_contrast, aes(x = contrast_diff, y = success_rate)) +
  geom_point() +  # Add the scatter plot points
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # Add a linear regression line
  theme_minimal() +
  labs(x = "Contrast Difference", 
       y = "Success Rate", 
       title = "Correlation between Contrast Difference and Success Rate")


```
Thisplot affirms our assumptions as can be seen with the positive/upward line. As the contrast difference increases, the success rate increases as well. 

### Does the success rate difference among mice caused by the different distributions of contrast difference? 
```{r,echo=FALSE}
counts_df <- full_functional_tibble[c('mouse_name', 'contrast_diff')]
counts_df$contrast_diff <- as.factor(counts_df$contrast_diff)
counts <- table(counts_df)

percentages <- prop.table(counts, margin = 1)
percentages

```
The question now becomes whether the success rate difference among mice is caused by the different distributions of contrast difference. We will use a two-way ANOVA to answer this question and test the interactions effect. 

```{r, echo = FALSE}

# Assuming full_tibble is your original dataset and it includes the columns:
# - session_id: The ID for each session
# - contrast_diff: The difference in contrast between two conditions or stimuli
# - feedback_type: A binary indicator of success (1) or failure (0) in each trial

# The following R code snippet calculates the success rate for each combination of session_id and contrast_diff
library(dplyr)

success_rate_df <- full_tibble %>%
  group_by(session_id, contrast_diff) %>%
  summarize(success_rate = mean(feedback_type == 1), .groups = 'drop')

# Perform the two-way ANOVA
anova_result <- aov(success_rate ~ session_id * contrast_diff, data = success_rate_df)

# Get the summary of the ANOVA result
anova_result_summary <- summary(anova_result)
print(anova_result)
print(anova_result_summary)

sst <- sum((success_rate_df$success_rate - mean(success_rate_df$success_rate))^2)
sse <- anova_result_summary[[1]]$"Residuals"["Sum Sq"]


# Extract the Mean Square Error (MSE) as a numeric value
# 'Residuals' is the last row in the summary output, and 'Mean Sq' is usually the second column.
mse <- anova_result_summary[[1]]$'Residuals'["Mean Sq"]

# Ensure that mse is numeric
mse <- as.numeric(mse)

# Now calculate the Residual Standard Error (RSE)
rse <- sqrt(mse)

# Print the RSE
cat("Residual Standard Error (RSE):", rse, "\n")


# Print SST, SSE, and RSE
cat("Total Sum of Squares (SST):", sst, "\n")
cat("Sum of Squares due to Error (SSE):", sse, "\n")


```

```{r, echo = FALSE, include = FALSE}
# Critical value of F at alpha = 0.05
#df_num <- anova_result_summary$contrast_diff[1] # Replace with the specific df for your factor of interest
f_critical <- qf(0.95, 4, 17)

# Print the critical value of F
cat("Critical F-value (F*):", f_critical, "\n")


```
Comparing the F statistic to the critical F-value, we can conclude that there is a significant interaction effect.


### Visualize success rate change over time (trail)
```{r,echo=FALSE, include = FALSE}
full_functional_tibble$trail_group = cut(full_functional_tibble$trail_id, breaks = seq(0, max(full_functional_tibble$trail_id), by = 25),include.lowest = TRUE)
levels(full_functional_tibble$trail_group) <- seq(0, max(full_functional_tibble$trail_id), by = 25)[2:18]
```

```{r,echo=FALSE}
success_rate <- aggregate(success ~ session_id + trail_group, data = full_functional_tibble, FUN = function(x) mean(x) )
ggplot(success_rate, aes(x = trail_group, y = success)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~session_id, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Slant the x-axis labels


```
The success rate change over time for individual sessions divided by trial groups of 25 each. Each sessions has a different pattern and thus it is difficult to make overarching conclusions among the sessions that mice share. 

```{r,echo=FALSE}
success_rate <- aggregate(success ~ mouse_name + trail_group, data = full_functional_tibble, FUN = function(x) mean(x) )
ggplot(success_rate, aes(x = trail_group, y = success)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~mouse_name) +
      theme_bw()
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Slant x-axis text

```
The success rate change over time for individual mouse divided by trial groups of 25 each. Each mouse has a different pattern and thus it is difficult to make overarching conclusions among the mice. However, we can see that Cori, Forssmann, and Lederberg have slight declines in their success rate which is what we already seen in our base evaluations.


# Visualize the change of overall neuron spike rate over time (across sessions and mice)
```{r,echo=FALSE, include = FALSE}
col_names <-names(full_functional_tibble)
region_sum_subset <- col_names[grep("^region_sum", col_names)]
region_mean_subset <- col_names[grep("^region_mean", col_names)]

```

```{r,echo=FALSE}
# average_spike <- full_tibble %>% group_by( session_id,trail_id) %>% summarise(mean_spike = mean(region_mean_spike))
average_spike <- full_tibble %>% group_by( session_id,trail_id) %>% summarise(mean_spike = sum(region_sum_spike)/sum(region_count))

average_spike$mouse_name <- full_functional_tibble$mouse_name
average_spike$contrast_diff <- full_functional_tibble$contrast_diff
average_spike$success <- full_functional_tibble$success
```
```{r,echo=FALSE}
ggplot(average_spike, aes(x = trail_id, y = mean_spike)) + 
  geom_line()+
  geom_smooth(method = "loess")+  # Fit a smooth spline

  facet_wrap(~session_id)
```
This session shows the change of overall neuron spike rate for each session. Most sessions experience a decline in average spikes though some sessions start with higher average spikes, such as sessions 1 and 13; while some sessions have great spread of their average spikes, such as in sessions 9 and 11. 

```{r,echo=FALSE}
ggplot(average_spike, aes(x = trail_id, y = mean_spike)) + 
  geom_line()+
  geom_smooth(method = "loess")+  # Fit a smooth spline

  facet_wrap(~mouse_name)
```
This plot shows the change of overall neuron spike rate for each mouse. Since we already found the success rate per mouse, this plot demonstrates the overall neuron spike rate for each mouse. It is important to note that Lederberg has the highest success rate among the mice and also seems to have a greater variability in its overall neuron spike rate. With that, it is also noticeable that each mouse displays a decrease in its overall neuron spike rate over time, though there are various patterns before that gradual decline which is seen in Cori and Lederberg. 


# Dimension Reduction
```{r,echo=FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)

```

```{r, echo = FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)
full_tibble$avg_spks = full_tibble$region_mean_spike


```

```{r, echo = FALSE}
library(tidyverse)
library(cluster) # For clustering algorithms

# Assuming full_tibble is your data frame and it's already been processed correctly:
# Select the variables for clustering
clustering_data <- full_tibble %>% 
  select(avg_spks, success) %>% 
  na.omit()  # Remove NA values

# Decide on the number of clusters (k) - for this example, I'll use k = 3
# You might want to use the 'elbow method' or 'silhouette method' to find the optimal number of clusters
set.seed(42) # For reproducibility
k <- 3
kmeans_result <- kmeans(clustering_data, centers = k)

# Attach the cluster assignments back to the original data
clustering_data$cluster <- kmeans_result$cluster

# Analyze the results
# Check the distribution of data points among clusters
print(table(clustering_data$cluster))

# Visualize the clusters
ggplot(clustering_data, aes(x = avg_spks, y = success, color = factor(cluster))) +
  geom_point() +
  labs(title = "K-means Clustering of avg_spks and success", 
       x = "Average Spike Count", 
       y = "Success", 
       color = "Cluster") +
  theme_minimal()


```
Since the clusters are horizontally aligned (left to right), it suggests that avg_spks doesn't vary much within clusters but success does.
Additionally, since the clusters are tight and well-separated, it suggests that the K-means algorithm was able to find distinct groups based on the data provided. There is a cluster with high avg_spks and high success, it might imply that higher spike counts are associated with success in the context of the data, which are conclusions we drew in most sessions. 

```{r, echo = FALSE}
library(tidyverse)
library(cluster)

# Assuming full_tibble is already loaded with the necessary data

# Selecting the relevant columns for K-means clustering
data_to_cluster <- full_tibble %>% 
  select(contrast_diff, avg_spks)

# Run K-means clustering with 3 clusters (you may choose the number of clusters based on your data)
set.seed(42)  # Set a random seed for reproducibility
kmeans_result <- kmeans(data_to_cluster, centers = 3, nstart = 25)

# Adding the cluster assignments to the original data frame
full_tibble$cluster <- kmeans_result$cluster

# View the updated data frame
head(full_tibble)

# Optional: To visualize the clusters, you can use ggplot2
ggplot(full_tibble, aes(x = contrast_diff, y = avg_spks, color = factor(cluster))) +
  geom_point() +
  labs(title = "K-means Clustering of contrast_diff and avg_spks", 
       color = "Cluster")


```
Since clusters have distinct ranges of contrast_diff and avg_spks, this may suggest that certain levels of contrast difference and average spikes are associated with specific groups or outcomes in our data.High avg_spks in a cluster may indicate high neural activity under the conditions present in that cluster. Different contrast_diff levels within a cluster might reveal how variations in stimulus contrast affect the neural response.

```{r,echo=FALSE, include = FALSE}
binename <- paste0("bin", as.character(1:40))

get_trail_functional_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  trail_bin_average <- matrix(colMeans(spikes), nrow = 1)
  colnames(trail_bin_average) <- binename
  trail_tibble  = as_tibble(trail_bin_average)%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  
  trail_tibble
}
get_session_functional_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_functional_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- as_tibble(do.call(rbind, trail_list))
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r, echo = FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){ # this combienes all session data - you can change this 1:3 to do stuff for cori only
  session_list[[session_id]] <- get_session_functional_data(session_id)
}
full_functional_tibble <- as_tibble(do.call(rbind, session_list))
full_functional_tibble$session_id <- as.factor(full_functional_tibble$session_id )
full_functional_tibble$contrast_diff <- abs(full_functional_tibble$contrast_left-full_functional_tibble$contrast_right)

full_functional_tibble$success <- full_functional_tibble$feedback_type == 1
full_functional_tibble$success <- as.numeric(full_functional_tibble$success)
```

```{r, echo = FALSE, include = FALSE}
features = full_functional_tibble[,1:40]
scaled_features <- scale(features)
pca_result <- prcomp(scaled_features)
pc_df <- as.data.frame(pca_result$x)
pc_df$session_id <- full_functional_tibble$session_id
pc_df$mouse_name <- full_functional_tibble$mouse_name
```

```{r, echo = FALSE}
ggplot(pc_df, aes(x = PC1, y = PC2, color = session_id)) +
  geom_point() +
  labs(title = "PCA: PC1 vs PC2")
```
Some sessions do not have clusters and despite knowing what sessions belong to each mice, there are no clusters among sessions and among mice. The only obvious clusters are found in sessions 13 and 15. We know that these belong to Lederberg. It is possible that this can viewed in relation to success rate. Sessions 13 and 15 have some of the highest success rates and employ clear clusters. 

The dots are colored for different mouse 
```{r, echo = FALSE}
ggplot(pc_df, aes(x = PC1, y = PC2, color = mouse_name)) +
  geom_point() +
  labs(title = "PCA: PC1 vs PC2")
```
Employing dimension reduction through PCA by mouse provides interesting information. Despite a clear-cut cluster for some mice like Forssmann, other mice seem to not cluster close to one another for Cori, Hench, and Lederberg. 

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r,echo=FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)

```

For data processing, I decided to build on the full_tibble by removing the column of the date experiment. I will continue to build on the full_tibble for my data integration and predictive modelling steps. 
```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r,echo=FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)

```

```{r, echo = FALSE, include = FALSE}
head(full_tibble)

```

```{r, include = FALSE, echo = FALSE}
library(dplyr)

# Assuming full_tibble is your data frame and you want to remove columns named 'column1', 'column2', 'column3'
full_tibble_updated <- full_tibble %>%
  select(-date_exp)

# View the updated tibble
head(full_tibble_updated)

```

```{r, echo = FALSE}
library(tidyverse)
library(cluster)

# Assuming full_tibble is your data frame

# Select and standardize the relevant variables
data_for_clustering <- full_tibble %>%
  select(region_sum_spike, region_mean_spike, contrast_diff) %>%
  scale()

set.seed(42) # For reproducibility
kmeans_result <- kmeans(data_for_clustering, centers = 3, nstart = 20)

# Add cluster assignments to the original data
full_tibble$cluster <- kmeans_result$cluster

# Explore the resulting clusters
ggplot(full_tibble, aes(x = region_sum_spike, y = region_mean_spike, color = as.factor(cluster))) +
  geom_point(alpha = 0.6) +
  facet_wrap(~cluster, scales = "fixed") +
  labs(title = "K-means Clustering on Neural Activity and Contrast Difference",
       x = "Region Sum Spike",
       y = "Region Mean Spike",
       color = "Cluster")


```
The clusters located in the bottom left likely represent groups of trials or observations with lower values of region_sum_spike and region_mean_spike. This could indicate periods or sessions of lower neural activity or simpler stimuli conditions that don't elicit strong neural responses, which were seen in some brain areas in some of the sessions' EDA (when some brain areas elicited much lower average spike counts when compared to other sessions). The proximity of these two clusters to each other suggests they might share similarities in neural activity levels, but there could be subtle differences captured by the clustering algorithm, possibly related to contrast_diff. The cluster that extends from the bottom left towards the middle of the plot represents observations that show a transition in neural activity levels. This cluster might include trials that are more variable in terms of neural response, capturing a broader range of conditions or stimuli intensities that elicit moderate neural activity. We particularly have seen trials at the end of most sessions that resulted in failures. The distribution of this cluster suggests there is a subgroup within your data that bridges low and moderate activity levels, which could be of particular interest stemming from the patterns from at the end of most sessions. 

```{r, echo = FALSE}
library(ggfortify)

# Example of performing PCA
pca_result <- prcomp(data_for_clustering, scale. = TRUE)
summary(pca_result) # To see variance explained
autoplot(pca_result, data = full_tibble, colour = 'cluster') # Using ggfortify for visualization



```
Since darker colors represent higher densities of points or particular clusters of interest, this indicates regions of the plot where data points are more concentrated. These could signify more homogeneous subgroups within my data according to the principal components. The presence of clusters in the PCA plot suggests that there are distinct subgroups in my dataset that differ in their patterns of variance along the principal components.
The progression from top right to bottom left could indicate a continuous variation in some biological and/or  experimental condition of the mice or trials represented in the data. For instance, it could be related to the degree of neural activity as captured by avg_spks or the difference in stimuli strength as captured by contrast_diff. Since my PCA visualization includes vectors for the original variables, the vectors pointing in the same direction as the cluster spread might be the variables most responsible for the differentiation of those clusters.

```{r echo=FALSE,  include = FALSE, eval=TRUE}
setwd("C:/Users/19162/Desktop/STA141A Project/Data/sessions/")

# Load the data 
session=list()
for(i in 1:18){
  session[[i]]=readRDS(paste("session", i,'.rds',sep=''))
}

```

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- session[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= session[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"= session[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= session[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_session_data <- function(session_id){
  n_trail <- length(session[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  session_tibble <- do.call(rbind, trail_list)
  session_tibble <- session_tibble %>% add_column("mouse_name" = session[[session_id]]$mouse_name) %>% add_column("date_exp" = session[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  session_tibble
}

```

```{r,echo=FALSE, include = FALSE}
session_list = list()
for (session_id in 1: 18){
  session_list[[session_id]] <- get_session_data(session_id)
}
full_tibble <- do.call(rbind, session_list)
full_tibble$success <- full_tibble$feedback_type == 1
full_tibble$success <- as.numeric(full_tibble$success)
full_tibble$contrast_diff <- abs(full_tibble$contrast_left-full_tibble$contrast_right)

```

```{r, echo = FALSE, include = FALSE}
head(full_tibble)

```


```{r, echo = FALSE, include = FALSE}
library(dplyr)

# Assuming full_tibble is your data frame and you want to remove columns named 'column1', 'column2', 'column3'
full_tibble_updated <- full_tibble %>%
  select(-date_exp)

# View the updated tibble
head(full_tibble_updated)

```




# Data Integration
I decide to use trails from all sessions for my data integration. The features I decided to use are session_id, trail_id, region_count, average spikes, brain area, contrast right, contrast left, and contrast difference. I made sure to particularly include average spikes and brain area considering that there was a positive correlation between feedback and average spikes in most brain areas among the sessions.

```{r, echo = FALSE, include = FALSE}
predictive_feature <- c("session_id","trail_id", "region_count", "region_mean_spike", "brain_area", "contrast_right","contrast_left", "contrast_diff")
head(full_tibble_updated[predictive_feature])
```

```{r,echo=FALSE, include = FALSE}
predictive_dat <- full_tibble_updated[predictive_feature]
#predictive_dat$success <- as.numeric(predictive_dat$success)
predictive_dat$trail_id <- as.numeric(predictive_dat$trail_id)
label <- as.numeric(full_tibble_updated$success)
X <- model.matrix(~., predictive_dat)

```

# Prediction
## I decided to train the model on 80% trails and test it on the rest 

```{r, echo = FALSE, include = FALSE}
# split
set.seed(123) # for reproducibility
trainIndex <- createDataPartition(label, p = .8, 
                                  list = FALSE, 
                                  times = 1)
train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

I decide to go with xgboost because I have lots of features, I expect there are some interactions among those interactions, and I have a relative large training set to avoid overfitting. 

```{r, echo = FALSE, include = FALSE}
suppressWarnings(library(xgboost))
library(xgboost)
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)

```

Prediction results (accuracy, confusion matrix, AUROC)
```{r, echo = FALSE}
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy

```
Accuracy: 78.94%

```{r, echo = FALSE}
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table

```
Above is the confusion matrix as a table.

```{r, echo= FALSE}
# Assuming conf_matrix is already calculated as shown in your snippet
total_predictions <- sum(conf_matrix$table)
correct_predictions <- sum(diag(conf_matrix$table))
incorrect_predictions <- total_predictions - correct_predictions

misclassification_error_rate <- incorrect_predictions / total_predictions

# Print the misclassification error rate
misclassification_error_rate


```
The misclassification_error_rate is 0.211.

```{r, echo = FALSE}
auroc <- roc(test_label, predictions)
auroc
```
The auroc is 0.8432. 

## I then tested the model's performance on 50 random trails from session 18
```{r, echo = FALSE}
# split
set.seed(123) # for reproducibility
session_18_row <- which(full_tibble_updated$session_id==18)
testIndex <- sample(session_18_row, 50, replace = FALSE)
trainIndex <- 1:nrow(full_tibble_updated)
trainIndex <- trainIndex[!(trainIndex %in% testIndex)]

train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

Prediction results (accuracy, confusion matrix, AUROC)
```{r, echo = FALSE}
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table
auroc <- roc(test_label, predictions)
auroc
plot(auroc)
```
Accuracy = 0.9, auroc = 0.8672.

## I also tested the model's performance on 50 random trails from session 1
```{r,echo=FALSE, include = FALSE}
# split
set.seed(123) # for reproducibility
session_1_row <- which(full_tibble_updated$session_id==1)
testIndex <- sample(session_1_row, 50, replace = FALSE)
trainIndex <- 1:nrow(full_tibble_updated)
trainIndex <- trainIndex[!(trainIndex %in% testIndex)]

train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

Prediction results (accuracy, confusion matrix, AUROC)
```{r,echo=FALSE}
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table
auroc <- roc(test_label, predictions)
auroc
```
Accuracy: 0.68, auroc = 0.83

In the development of my prediction model, I employed the XGBoost algorithm due to its efficiency and performance in handling diverse datasets and complex predictive modeling challenges. Through split - training and validation, the model achieved an accuracy of 78.94%, reflecting its strong capability in correctly predicting outcomes within our dataset. Further, the model's AUROC (Area Under the Receiver Operating Characteristic curve) score stood at 0.84, indicating a high level of discriminative power in distinguishing between classes. This score is particularly significant as it showcases the model's ability to balance sensitivity and specificity effectively, making it a robust tool for our predictive tasks. The choice of XGBoost was driven by its advantages in speed and performance, as well as its flexibility in handling various types of data. The achieved accuracy and AUROC scores are testament to the careful feature selection, parameter tuning, and validation strategies we employed, ultimately leading to a predictive model that is both accurate and reliable for our specific application. Additionally, he testing of your XGBoost model on trials from sessions 18 and 1 yielded intriguing results, further demonstrating the model's performance across different subsets of your data. For session 18, the model achieved an accuracy of 90% and an AUROC of 0.8672. These metrics are noteworthy as they suggest that the model is exceptionally well-suited to the characteristics and patterns found within session 18's data, leading to highly accurate predictions and strong discriminative ability between classes in this specific context. However, when applied to session 1's data, the model's accuracy decreased to 68%, with an AUROC of 0.83. While the decrease in accuracy indicates a lower rate of correct predictions for this session, the AUROC remains relatively high. This suggests that despite the challenges in accurately classifying all instances correctly in session 1, the model still maintains a decent capability to differentiate between classes, though with less precision than observed in session 18. These differences in model performance across different sessions could be attributed to multiple factors, including differences in data distribution, the presence of unique or outlier characteristics in certain sessions or brain areas, or the varying difficulty of the prediction task across sessions or capabilities of the mice. The results emphasize the importance of considering session-specific nuances when deploying predictive models and highlight the potential need for session-specific tuning or adaptation to optimize performance across diverse datasets. For this reason, my session-specific EDA has significantly contributed to the success of my modeling efforts. Now, we shall access the performance of your prediction model on the outside test data. 

# Prediction Performance

```{r echo=TRUE, eval=TRUE, include = FALSE}
# Set working directory
setwd("C:/Users/19162/Desktop/STA141A Project/test data")

# Load the data 
test=list()
for(i in 1:2){
  test[[i]]=readRDS(paste("test", i,'.rds',sep=''))
}

```

```{r, echo = FALSE, include = FALSE}
test1 = readRDS("C:/Users/19162/Desktop/STA141A Project/test data/test1.rds")
names(test1)

```

```{r, echo = FALSE, include = FALSE}
get_trail_data <- function(session_id, trail_id){
  spikes <- test[[session_id]]$spks[[trail_id]]
  if (any(is.na(spikes))){
    disp("value missing")
  }

  #trail_tibble <- as_tibble(spikes) %>% set_names(binename) %>%  add_column("brain_area" = session[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( "sum_spikes" =across(everything(),sum),.groups = "drop") 
  trail_tibble <- tibble("neuron_spike" = rowSums(spikes))  %>%  add_column("brain_area" = test[[session_id]]$brain_area ) %>% group_by(brain_area) %>% summarize( region_sum_spike = sum(neuron_spike), region_count = n(),region_mean_spike = mean(neuron_spike)) 
  trail_tibble  = trail_tibble%>% add_column("trail_id" = trail_id) %>% add_column("contrast_left"= test[[session_id]]$contrast_left[trail_id]) %>% add_column("contrast_right"=test[[session_id]]$contrast_right[trail_id]) %>% add_column("feedback_type"= test[[session_id]]$feedback_type[trail_id])
  trail_tibble
}

```

```{r,echo=FALSE, include = FALSE}

get_test_data <- function(session_id){
  n_trail <- length(test[[session_id]]$spks)
  trail_list <- list()
  for (trail_id in 1:n_trail){
    trail_tibble <- get_trail_data(session_id,trail_id)
    trail_list[[trail_id]] <- trail_tibble
  }
  test_tibble <- do.call(rbind, trail_list)
  test_tibble <- test_tibble %>% add_column("mouse_name" = test[[session_id]]$mouse_name) %>% add_column("date_exp" = test[[session_id]]$date_exp) %>% add_column("session_id" = session_id) 
  test_tibble
}

```

```{r,echo=FALSE, include = FALSE}
test_list = list()
for (session_id in 1: 2){
  test_list[[session_id]] <- get_test_data(session_id)
}
new_tibble <- do.call(rbind, test_list)
new_tibble$success <- new_tibble$feedback_type == 1
new_tibble$success <- as.numeric(new_tibble$success)
new_tibble$contrast_diff <- abs(new_tibble$contrast_left-new_tibble$contrast_right)

```

```{r, echo = FALSE, include = FALSE}
head(new_tibble)

```

```{r, echo = FALSE, include = FALSE}
library(dplyr)

# Assuming full_tibble is your data frame and you want to remove columns named 'column1', 'column2', 'column3'
new_tibble_updated <- new_tibble %>%
  select(-date_exp)

# View the updated tibble
head(new_tibble_updated)

```

```{r, echo = FALSE, include = FALSE}
predictive_feature <- c("session_id","trail_id", "region_count", "region_mean_spike", "brain_area", "contrast_right","contrast_left", "contrast_diff")
head(new_tibble_updated[predictive_feature])
```

```{r,echo=FALSE, include = FALSE}
predictive_dat <- new_tibble_updated[predictive_feature]
#predictive_dat$success <- as.numeric(predictive_dat$success)
predictive_dat$trail_id <- as.numeric(predictive_dat$trail_id)
label <- as.numeric(new_tibble_updated$success)
X <- model.matrix(~., predictive_dat)

```

# Prediction
## I decided to train the model on 80% trails and test it on the rest 

```{r, echo = FALSE, include = FALSE}
# split
set.seed(123) # for reproducibility
trainIndex <- createDataPartition(label, p = .8, 
                                  list = FALSE, 
                                  times = 1)
train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

I once again decide to go with xgboost because I have lots of features, I expect there are some interactions among those interactions, and I have a relative large training set to avoid overfitting. 

```{r, echo = FALSE}
suppressWarnings(library(xgboost))
library(xgboost)
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)

```

Prediction results (accuracy, confusion matrix, AUROC)
```{r, echo = FALSE}
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy

```
Accuracy: 0.933

```{r, echo = FALSE}
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table

```
Above is the confusion matrix as a table.

```{r}
# Assuming conf_matrix is already calculated as shown in your snippet
total_predictions <- sum(conf_matrix$table)
correct_predictions <- sum(diag(conf_matrix$table))
incorrect_predictions <- total_predictions - correct_predictions

misclassification_error_rate <- incorrect_predictions / total_predictions

# Print the misclassification error rate
misclassification_error_rate


```
The misclassification error rate for my performance is 0.066.

The auroc is 0.9432. 

## I then tested the model's performance on the first test data
```{r, echo = FALSE}
# split
set.seed(123) # for reproducibility
test_1_row <- which(new_tibble_updated$session_id==1)
testIndex <- sample(test_1_row, 50, replace = FALSE)
trainIndex <- 1:nrow(new_tibble_updated)
trainIndex <- trainIndex[!(trainIndex %in% testIndex)]

train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

Prediction results (accuracy, confusion matrix, AUROC)
```{r, echo = FALSE}
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table
auroc <- roc(test_label, predictions)
auroc
plot(auroc)
```
Accuracy = 0.9, auroc = 0.98

## I also tested the model's performance on test data 2
```{r,echo=FALSE, include = FALSE}
# split
set.seed(123) # for reproducibility
test_2_row <- which(new_tibble_updated$session_id==2)
testIndex <- sample(test_2_row, 100, replace = FALSE)
trainIndex <- 1:nrow(new_tibble_updated)
trainIndex <- trainIndex[!(trainIndex %in% testIndex)]

train_df <- predictive_dat[trainIndex, ]
train_X <- X[trainIndex,]
test_df <- predictive_dat[-trainIndex, ]
test_X <- X[-trainIndex,]

train_label <- label[trainIndex]
test_label <- label[-trainIndex]
```

Prediction results (accuracy, confusion matrix, AUROC)
```{r,echo=FALSE}
xgb_model <- xgboost(data = train_X, label = train_label, objective = "binary:logistic", nrounds=10)
predictions <- predict(xgb_model, newdata = test_X)
predicted_labels <- as.numeric(ifelse(predictions > 0.5, 1, 0))
accuracy <- mean(predicted_labels == test_label)
accuracy
conf_matrix <- confusionMatrix(as.factor(predicted_labels), as.factor(test_label))
conf_matrix$table
auroc <- roc(test_label, predictions)
auroc
```
Accuracy: 0.94.

While I'm satisfied with the performance of my model, I did face some challenges with the creation of this prediction model. A potential improvement I overlooked was the integration of feedback types into my training process. This step would have allowed me to explore any possible links between the neural data and the accuracy of the mouse's responses. 

*Discussion*
In this project, I explore the intricate relationship between neural activity and behavioral outcomes, leveraging data from Steinmetz et al.'s experiments. Our analysis reveals a predominant occurrence of trial failures at the end of each session, a notable correlation between spike counts and success or failure, and distinct distributions of neural activity associated with each outcome. These findings underscore the complexity of neural underpinnings in decision-making processes. Our results both align with and extend existing literature, suggesting that neural activity's role in behavioral outcomes is nuanced and multifaceted. Recognizing the limitations of our dataset and analysis, we advocate for further research to unravel these complex neural and behavioral interactions more comprehensively.

*Acknowledgements* 
Steinmetz, N.A., Zatka-Haas, P., Carandini, M. et al. Distributed coding of choice, action and engagement across the mouse brain. Nature 576, 266273 (2019). https://doi.org/10.1038/s41586-019-1787-x
Additionally, here is a link to my interaction with chatGPT:https://chat.openai.com/c/12727166-37f2-47bc-a4a0-0dcdd689f2ab (screen shots can be made available upon request). 
